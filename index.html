<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾å¤©å†™ä½œ - ç§»åŠ¨ç«¯é€‚é…ç‰ˆ</title>
  <style>
	:root{--bg:#121212;--card:#1e1e1e;--text:#e5e7eb;--subtext:#9ca3af;--tip:#6b7280;--border:#374151;--primary:#3b82f6;--success:#10b981;--light:#374151;--danger:#ff4444;}
	[data-theme="light"]{--bg:#f8fafc;--card:#fff;--text:#1f2937;--subtext:#6b7280;--border:#e2e8f0;--primary:#2563eb;--light:#f1f5f9;}
	*{box-sizing:border-box;font-family:"Microsoft YaHei",sans-serif;margin:0;padding:0}
	body{background:var(--bg);color:var(--text);line-height:1.6}
	.head-bar{position:sticky;top:0;z-index:999;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:6px;flex-wrap:nowrap;}
	.logo{
	  font-weight:700;
	  font-size:28px;
	  font-family:"STKaiti","KaiTi","æ¥·ä½“_GB2312","AR PL UKai CN",serif;
	  letter-spacing:2px;
	  background:linear-gradient(45deg, #d81f26, #000000);
	  -webkit-background-clip:text;
	  background-clip:text;
	  color:transparent;
	  margin-right:6px;
	  white-space:nowrap;
	}
	[data-theme="dark"] .logo{
	  background:linear-gradient(45deg, #ff3333, #ffd700);
	  -webkit-background-clip:text;
	  background-clip:text;
	  color:transparent;
	}
	/* ä¿®å¤ç§»åŠ¨ç«¯é¡¹ç›®é€‰æ‹©å™¨æ ·å¼ */
	.project-selector {
	  padding: 8px 12px;
	  border: 1px solid var(--border);
	  border-radius: 6px;
	  background: var(--card);
	  color: var(--text);
	  min-width: 120px;
	  height: 44px;
	  font-size: 16px;
	  -webkit-appearance: menulist-button;
	}
	.func-btn{padding:3px 6px;border:1px solid var(--border);border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;height:36px;display:flex;align-items:center;gap:3px;font-size:12px;}
	.func-btn:hover{background:var(--primary);color:#fff}
	.project-set-btn,.delete-project-btn{display:none;}
	.project-set-btn.show,.delete-project-btn.show{display:flex;}
	.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;display:none;}
	.modal-content{background:var(--card);padding:20px;border-radius:10px;max-width:360px;width:90%}
	.modal.active{display:flex}
	.main{max-width:1000px;margin:20px auto;padding:0 12px}
	.step-nav-wrap{display:flex;align-items:center;gap:8px;margin-bottom:16px;}
	.step-nav{display:flex;gap:8px;flex-wrap:wrap;}
	.step-nav .nav{padding:8px 12px;border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;font-size:14px}
	.step-nav .nav.active{background:var(--primary);color:#fff}
	.back-btn{padding:8px 12px;border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;font-size:14px;}
	.back-btn:disabled{opacity:0.5;cursor:not-allowed;}
	.step-box{background:var(--card);border-radius:10px;padding:16px;margin-bottom:16px}
	.step-title{font-size:17px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px}
	.step-title span{width:24px;height:24px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px}
	.form-item{margin-bottom:12px}
	.label{font-weight:600;margin-bottom:6px;display:block;font-size:14px}
	input,textarea,select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);font-size:14px;outline:0}
	textarea{min-height:90px;resize:vertical}
	.btn{padding:10px 16px;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px}
	.btn-primary{background:var(--primary);color:#fff}
	.btn-success{background:var(--success);color:#fff}
	.btn-light{background:var(--light);color:var(--text)}
	.btn-danger{background:var(--danger);color:#fff}
	.btn-group{display:flex;gap:8px;flex-wrap:nowrap;margin-top:10px;}
	.btn-dual-container{display:flex;justify-content:space-between;align-items:center;margin-top:12px;}
	.btn-triple-container{display:flex;justify-content:space-between;align-items:center;margin-top:12px;gap:8px;}
	.hide{display:none}
	.loading{color:var(--primary);font-weight:600;margin:8px 0;font-size:14px;}
	.progress-container{width:100%;height:6px;background:var(--light);border-radius:3px;margin-top:6px;overflow:hidden;}
	.progress-bar{height:100%;background:var(--primary);border-radius:3px;width:0%;transition:width 0.3s ease;}
	.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
	.core-card{border:1px solid var(--border);border-radius:8px;padding:12px;background:var(--card);cursor:pointer}
	.core-card:hover{border-color:var(--primary)}
	.core-card.active{border-color:var(--success);background:rgba(16,185,129,0.1)}
	.chapter-item{margin-bottom:12px;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--card);box-shadow:0 1px 2px rgba(0,0,0,0.08);}
	.chapter-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
	.chapter-left{display:flex;align-items:center;}
	.chapter-num{color:var(--primary);font-size:16px;font-weight:700;}
	.chapter-toggle-btn{cursor:pointer;margin-left:8px;padding:2px 6px;border-radius:4px;background:var(--light);color:var(--text);font-size:12px;}
	.chapter-single-word{font-size:12px;color:var(--subtext);margin-left:8px;}
	.chapter-operate{display:flex;gap:6px;}
	.chapter-copy-btn{font-size:12px;padding:2px 6px;border-radius:4px;background:var(--light);color:var(--text);cursor:pointer;}
	.chapter-delete-btn{font-size:12px;padding:2px 6px;border-radius:4px;background:var(--danger);color:#fff;cursor:pointer;}
	.chapter-footer{text-align:right;margin-top:12px;}
	.chapter-content{line-height:1.8;display:block;}
	.result{background:var(--bg);padding:14px;border-radius:8px;margin-top:12px;white-space:pre-wrap;}
	.total-word-wrap{text-align:right;font-size:13px;color:var(--subtext);margin-top:8px;}
	.word-count{font-size:12px;color:var(--subtext);margin-top:4px;text-align:right;}
	.chapter-suggestion{margin-top:8px;padding:8px;background:rgba(59,130,246,0.1);border-radius:4px;font-size:13px;color:var(--subtext)}
	.style-row{display:flex;gap:12px;margin-top:10px;}
	.style-col{flex:1;}
	.volume-check-tip{margin-top:8px;padding:8px;background:rgba(245,158,11,0.1);border-radius:4px;font-size:13px;color:var(--text);display:flex;justify-content:space-between;align-items:center;}
  </style>
</head>
<body>
<div class="head-bar">
  <div class="logo">å¾å¤©å†™ä½œ</div>
  <select id="projectSelector" class="project-selector" onchange="switchProject()"></select>
  <button class="func-btn delete-project-btn" id="topDeleteBtn" onclick="showDelModal()">ğŸ—‘ï¸ åˆ é™¤</button>
  <button class="func-btn" onclick="newProjectModal()">ğŸ“ æ–°å»º</button>
  <button class="func-btn" onclick="toggleSet()">âš™ï¸ è®¾ç½®</button>
  <button class="func-btn" id="themeBtn">â˜€ï¸ æ—¥é—´</button>
</div>

<div class="modal" id="delModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ—‘ï¸</span> åˆ é™¤é¡¹ç›®</div>
  <p style="margin-bottom:15px;">åˆ é™¤åæ‰€æœ‰å†…å®¹æ°¸ä¹…æ¶ˆå¤±ï¼Œä¸å¯æ¢å¤ï¼</p>
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideDelModal()">å–æ¶ˆ</button>
	<button class="btn btn-danger" onclick="deleteProjectForever()">ç¡®è®¤åˆ é™¤</button>
  </div>
</div></div>

<div class="modal" id="delChapterModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ—‘ï¸</span> åˆ é™¤ç« èŠ‚</div>
  <p style="margin-bottom:15px;">ç¡®è®¤åˆ é™¤è¯¥ç« èŠ‚ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤ï¼</p>
  <input type="hidden" id="delChapterNum" value="">
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideDelChapterModal()">å–æ¶ˆ</button>
	<button class="btn btn-danger" onclick="deleteChapterForever()">ç¡®è®¤åˆ é™¤</button>
  </div>
</div></div>

<div class="modal" id="volumeCheckModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ“Š</span> ç»†çº²ä½“é‡æ ¡éªŒ</div>
  <p style="margin-bottom:12px;">å½“å‰ç»†çº²é¢„è®¡æ€»å­—æ•°ï¼š<span id="estimatedWords" style="color:var(--primary);font-weight:600;"></span></p>
  <p style="margin-bottom:15px;">ä¸ç›®æ ‡å­—æ•°ï¼ˆ<span id="targetWords" style="color:var(--primary);font-weight:600;"></span>ï¼‰åå·®è¶…20%ï¼Œæ˜¯å¦ä¼˜åŒ–ï¼Ÿ</p>
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideVolumeCheckModal()">ä¿ç•™åŸç»†çº²</button>
	<button class="btn btn-primary" onclick="optimizeDetailByTarget()">é€‚é…ç›®æ ‡å­—æ•°</button>
  </div>
</div></div>

<div class="modal" id="settingExtractModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ“</span> æ ¸å¿ƒè®¾å®šæ›´æ–°</div>
  <p style="margin-bottom:15px;">å·²è‡ªåŠ¨æå–å‰<span id="extractChapterCount" style="color:var(--primary);font-weight:600;"></span>ç« æ ¸å¿ƒè®¾å®šï¼Œç¡®ä¿åç»­åˆ›ä½œä¸åç¦»ï¼</p>
  <button class="btn btn-primary" onclick="hideSettingExtractModal()">ç¡®è®¤</button>
</div></div>

<div class="modal" id="newModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ“š</span> æ–°å»ºé¡¹ç›®</div>
  <div class="form-item"><input type="text" id="newName" placeholder="è¾“å…¥é¡¹ç›®å"></div>
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideNewModal()">å–æ¶ˆ</button>
	<button class="btn btn-primary" onclick="createCleanProject()">åˆ›å»º</button>
  </div>
</div></div>

<div class="modal" id="setModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ”‘</span> APIè®¾ç½®</div>
  <div class="form-item"><input type="text" id="apiKey" placeholder="API Keyï¼ˆsk-xxxxï¼‰"></div>
  <div class="form-item"><input type="text" id="model" value="deepseek-chat" placeholder="æ¨¡å‹"></div>
  <div class="form-item"><input type="number" id="temp" value="0.7" step="0.1" min="0.1" max="1.0" placeholder="æ¸©åº¦(0.1-1.0)"></div>
  <div class="form-item"><input type="number" id="maxTokens" value="2048" placeholder="æœ€å¤§Tokens"></div>
  <div class="form-item">
	<label class="label">æ ¸å¿ƒè®¾å®šæå–é—´éš”ï¼ˆç« ï¼‰</label>
	<input type="number" id="extractInterval" value="50" min="10" max="200" step="10" placeholder="æ¯Xç« æå–ä¸€æ¬¡">
  </div>
  <div class="btn-group"><button class="btn btn-primary" onclick="saveApi()">ä¿å­˜è®¾ç½®</button></div>
</div></div>

<div class="main">
  <div class="step-nav-wrap">
	<button class="back-btn" id="backBtn" disabled onclick="goPrevStep()">â† è¿”å›</button>
	<div class="step-nav">
	  <div class="nav" data-step="1" onclick="goStep(1)">1 æ•…äº‹æ ¸</div>
	  <div class="nav" data-step="2" onclick="goStep(2)">2 å¤§çº²</div>
	  <div class="nav" data-step="3" onclick="goStep(3)">3 ç»†çº²</div>
	  <div class="nav" data-step="4" onclick="goStep(4)">4 ç« çº²</div>
	  <div class="nav" data-step="5" onclick="goStep(5)">5 æ­£æ–‡</div>
	  <div class="nav" data-step="6" onclick="goStep(6)">6 AIä¿®æ”¹(é€‰å¡«)</div>
	</div>
  </div>

  <div id="step1" class="step-page">
	<div class="step-box"><div class="step-title"><span>1</span>çµæ„Ÿ/å…³é”®è¯ + åˆ›ä½œè®¾å®š</div>
	  <div class="form-item"><textarea id="idea" placeholder="è¾“å…¥çµæ„Ÿã€å…³é”®è¯æˆ–åˆæ­¥è®¾å®š" oninput="saveNow()"></textarea></div>
	  <div class="style-row">
		<div class="style-col">
		  <label class="label">å™äº‹è§†è§’</label>
		  <select id="viewSelect" onchange="saveNow()">
			<option value="ç¬¬ä¸‰äººç§°">ç¬¬ä¸‰äººç§°ï¼ˆé»˜è®¤ï¼‰</option>
			<option value="ç¬¬ä¸€äººç§°">ç¬¬ä¸€äººç§°</option>
		  </select>
		</div>
		<div class="style-col">
		  <label class="label">å†™ä½œé£æ ¼</label>
		  <select id="styleSelect" onchange="saveNow()">
			<option value="å°ç™½ç›´ç™½çˆ½æ–‡">å°ç™½ç›´ç™½çˆ½æ–‡ï¼ˆé»˜è®¤ï¼‰</option>
			<option value="éƒ½å¸‚å†™å®">éƒ½å¸‚å†™å®</option>
			<option value="å¤é£ç»†è…»">å¤é£ç»†è…»</option>
			<option value="æ‚¬ç–‘ç´§å‡‘">æ‚¬ç–‘ç´§å‡‘</option>
			<option value="æ ¡å›­æ¸…æ–°">æ ¡å›­æ¸…æ–°</option>
		  </select>
		</div>
	  </div>
	  <div class="btn-dual-container">
		<button class="btn btn-primary" onclick="genCore()">ç”Ÿæˆæ•…äº‹æ ¸</button>
		<button class="btn btn-primary" onclick="genCore()">ç”Ÿæˆæ•…äº‹æ ¸</button>
	  </div>
	  <div id="coreLoading" class="loading hide">
		æ­£åœ¨ç”Ÿæˆæ•…äº‹æ ¸...
		<div class="progress-container">
		  <div class="progress-bar" id="coreProgressBar"></div>
		</div>
	  </div>
	  <div id="coreGrid" class="card-grid hide"></div>
	  <div class="btn-triple-container">
		<button class="btn btn-success hide" id="next1Left" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button>
		<button class="btn btn-light" style="visibility:hidden;">å ä½</button>
		<button class="btn btn-success hide" id="next1Right" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button>
	  </div>
	</div>
  </div>

  <div id="step2" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>2</span>é€†æ¨å¤§çº²</div>
	  <div class="form-item">
		<label class="label">ç›®æ ‡æ€»å­—æ•°ï¼ˆä¸‡å­—ï¼‰</label>
		<input type="number" id="totalWan" value="0.5" min="0.1" step="0.1" oninput="updateChapterSuggestion()">
		<div id="chapterSuggestion" class="chapter-suggestion hide"></div>
	  </div>
	  <div class="btn-dual-container">
		<button class="btn btn-primary" onclick="genOutline()">ç”Ÿæˆå¤§çº²</button>
		<button class="btn btn-primary" onclick="genOutline()">ç”Ÿæˆå¤§çº²</button>
	  </div>
	  <div id="outlineLoading" class="loading hide">
		æ­£åœ¨ç”Ÿæˆå¤§çº²...
		<div class="progress-container">
		  <div class="progress-bar" id="outlineProgressBar"></div>
		</div>
	  </div>
	  <div class="form-item">
		<label class="label">å¤§çº²å†…å®¹</label>
		<textarea id="outline" rows="8" oninput="saveNow()"></textarea>
		<div class="word-count" id="outlineWordCount">å­—æ•°: 0</div>
	  </div>
	  <div class="btn-triple-container">
		<button class="btn btn-success" onclick="goStep(3)">ä¸‹ä¸€æ­¥</button>
		<button class="btn btn-light" onclick="copyOutline()">å¤åˆ¶å¤§çº²</button>
		<button class="btn btn-success" onclick="goStep(3)">ä¸‹ä¸€æ­¥</button>
	  </div>
	</div>
  </div>

  <div id="step3" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>3</span>ç»†çº²</div>
	  <div class="btn-dual-container">
		<button class="btn btn-primary" onclick="genDetail()">ç”Ÿæˆç»†çº²</button>
		<button class="btn btn-primary" onclick="genDetail()">ç”Ÿæˆç»†çº²</button>
	  </div>
	  <div id="detailLoading" class="loading hide">
		æ­£åœ¨ç”Ÿæˆç»†çº²...
		<div class="progress-container">
		  <div class="progress-bar" id="detailProgressBar"></div>
		</div>
	  </div>
	  <div id="detailVolumeTip" class="volume-check-tip hide"></div>
	  <div class="form-item">
		<label class="label">ç»†çº²å†…å®¹</label>
		<textarea id="detail" rows="10" oninput="saveNow()"></textarea>
		<div class="word-count" id="detailWordCount">å­—æ•°: 0</div>
	  </div>
	  <div class="btn-triple-container">
		<button class="btn btn-success" onclick="goStep(4)">ä¸‹ä¸€æ­¥</button>
		<button class="btn btn-light" onclick="copyDetail()">å¤åˆ¶ç»†çº²</button>
		<button class="btn btn-success" onclick="goStep(4)">ä¸‹ä¸€æ­¥</button>
	  </div>
	</div>
  </div>

  <!-- ç« çº²æ¨¡å—ï¼šæ‰‹åŠ¨æ£€æµ‹ç»†çº²ä½“é‡ -->
  <div id="step4" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>4</span>ç« çº²</div>
	  <!-- æ‰‹åŠ¨æ£€æµ‹æŒ‰é’® -->
	  <button class="btn btn-primary" id="manualCheckBtn" onclick="autoCheckDetailVolume()">æ£€æµ‹ç»†çº²ä½“é‡</button>
	  <!-- æ£€æµ‹ç»“æœåŒºåŸŸ -->
	  <div id="detailVolumeCheckResult" class="volume-check-tip hide"></div>
	  <div id="checkLoading" class="loading hide">
		æ­£åœ¨æ ¡éªŒç»†çº²ä½“é‡...
		<div class="progress-container">
		  <div class="progress-bar" id="checkProgressBar"></div>
		</div>
	  </div>
	  <!-- ç”Ÿæˆç« çº²/è¿”å›æŒ‰é’® -->
	  <div class="btn-dual-container" id="zhangGenBtnGroup" style="display:none;">
		<button class="btn btn-primary" onclick="genZhang()">ç”Ÿæˆç« çº²</button>
		<button class="btn btn-primary" onclick="genZhang()">ç”Ÿæˆç« çº²</button>
	  </div>
	  <div class="btn-dual-container" id="backToDetailBtnGroup" style="display:none;">
		<button class="btn btn-light" onclick="goStep(3)">â† è¿”å›ç»†çº²ä¿®æ”¹</button>
		<button class="btn btn-primary" onclick="optimizeDetailByTarget()">ä¸€é”®ä¼˜åŒ–ç»†çº²</button>
	  </div>
	  <div id="zhangLoading" class="loading hide">
		æ­£åœ¨ç”Ÿæˆç« çº²...
		<div class="progress-container">
		  <div class="progress-bar" id="zhangProgressBar"></div>
		</div>
	  </div>
	  <div class="form-item">
		<label class="label">ç« çº²å†…å®¹</label>
		<textarea id="zhang" rows="12" oninput="saveNow()"></textarea>
		<div class="word-count" id="zhangWordCount">å­—æ•°: 0</div>
	  </div>
	  <div class="btn-triple-container">
		<button class="btn btn-success" onclick="goStep(5)">ä¸‹ä¸€æ­¥</button>
		<button class="btn btn-light" onclick="copyZhang()">å¤åˆ¶ç« çº²</button>
		<button class="btn btn-success" onclick="goStep(5)">ä¸‹ä¸€æ­¥</button>
	  </div>
	</div>
  </div>

  <!-- æ­£æ–‡æ¨¡å—ï¼šå‰©ä½™ç« èŠ‚æç¤º -->
  <div id="step5" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>5</span>æ­£æ–‡ç”Ÿæˆ</div>
	  <div class="form-item">
		<label class="label">ç« èŠ‚å·</label>
		<input type="number" id="chapNum" value="1" min="1" step="1">
		<!-- å‰©ä½™ç« èŠ‚æç¤º -->
		<div id="chapterRemainTip" class="chapter-suggestion" style="margin-top:8px;">å·²ç”Ÿæˆ0ç«  / å…±éœ€0ç« ï¼Œè¿˜å‰©0ç« </div>
	  </div>
	  <div class="btn-dual-container">
		<button class="btn btn-primary" onclick="writeChap()">ç”Ÿæˆç« èŠ‚</button>
		<button class="btn btn-primary" onclick="writeChap()">ç”Ÿæˆç« èŠ‚</button>
	  </div>
	  <div id="chapLoading" class="loading hide">
		æ­£åœ¨ç”Ÿæˆæ­£æ–‡...
		<div class="progress-container">
		  <div class="progress-bar" id="chapProgressBar"></div>
		</div>
	  </div>
	  <div class="btn-group">
		<button class="btn btn-light" onclick="copyAllText()">âœ… å¤åˆ¶æ‰€æœ‰ç« èŠ‚</button>
		<button class="btn btn-light" onclick="exportTxt()">ğŸ“„ å¯¼å‡ºTXT</button>
	  </div>
	  <div class="form-item">
		<label class="label">æ­£æ–‡å†…å®¹</label>
		<div id="resultWrite" class="result"></div>
		<div class="total-word-wrap" id="totalWordWrap">æ€»å­—æ•°: 0</div>
	  </div>
	  <div class="btn-triple-container">
		<button class="btn btn-light" onclick="goStep(6)">â†’ è¿›å…¥AIä¿®æ”¹</button>
		<button class="btn btn-light" style="visibility:hidden;">å ä½</button>
		<button class="btn btn-light" onclick="goStep(6)">â†’ è¿›å…¥AIä¿®æ”¹</button>
	  </div>
	</div>
  </div>

  <div id="step6" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>6</span>AIä¿®æ”¹(é€‰å¡«)</div>
	  <div class="form-item">
		<label class="label">é€‰æ‹©ç« èŠ‚</label>
		<select id="editChap"></select>
	  </div>
	  <div class="form-item">
		<label class="label">ä¿®æ”¹å»ºè®®</label>
		<textarea id="editTip" placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®ï¼šå¦‚å¢åŠ æƒ…ç»ªã€è°ƒæ•´èŠ‚å¥ã€å±€éƒ¨æ”¹å†™"></textarea>
	  </div>
	  <div class="btn-dual-container">
		<button class="btn btn-primary" onclick="aiEdit()">æäº¤ä¿®æ”¹</button>
		<button class="btn btn-primary" onclick="aiEdit()">æäº¤ä¿®æ”¹</button>
	  </div>
	  <div id="editLoading" class="loading hide">
		æ­£åœ¨ä¿®æ”¹ç« èŠ‚...
		<div class="progress-container">
		  <div class="progress-bar" id="editProgressBar"></div>
		</div>
	  </div>
	  <div class="btn-triple-container">
		<button class="btn btn-light" onclick="goStep(5)">â† è¿”å›æ­£æ–‡</button>
		<button class="btn btn-light" style="visibility:hidden;">å ä½</button>
		<button class="btn btn-light" onclick="goStep(5)">â† è¿”å›æ­£æ–‡</button>
	  </div>
	</div>
  </div>
</div>

<script>
// å…¨å±€é»˜è®¤é…ç½®
const DEFAULT_BOOK = {
  idea: "",
  core: "",
  view: "ç¬¬ä¸‰äººç§°",
  style: "å°ç™½ç›´ç™½çˆ½æ–‡",
  total: 0.5,
  outline: "",
  detail: "",
  zhang: "",
  contents: [],
  coreSettings: {
	characters: [],
	worldView: "",
	coreConflict: "",
	styleConstraint: ""
  }
};
let globalData = JSON.parse(localStorage.getItem("writeData") || JSON.stringify({
  projects: {},
  api: "",
  model: "deepseek-chat",
  temp: 0.7,
  maxTokens: 2048,
  extractInterval: 50
}));
let currentId = null;
let currentStep = 1;
let BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
let progressTimer = null;

// ä¸»é¢˜åˆ‡æ¢
const themeBtn = document.getElementById("themeBtn");
themeBtn.onclick = () => {
  let dark = localStorage.getItem("theme") === "dark";
  dark = !dark;
  localStorage.setItem("theme", dark ? "dark" : "light");
  document.documentElement.setAttribute("data-theme", dark ? "dark" : "light");
  themeBtn.textContent = dark ? "ğŸŒ™ å¤œé—´" : "â˜€ï¸ æ—¥é—´";
}

// æ¸²æŸ“é¡¹ç›®ä¸‹æ‹‰+é¡¶éƒ¨åˆ é™¤æŒ‰é’®ï¼ˆå·²ä¿®å¤é€‰æ‹©é—®é¢˜ï¼‰
function renderSelect() {
  let sel = document.getElementById("projectSelector");
  sel.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®</option>';
  for (let id in globalData.projects) {
	let opt = document.createElement("option");
	opt.value = id;
	opt.textContent = globalData.projects[id].name;
	sel.appendChild(opt);
  }
  // ä¿®å¤é¡¹ç›®é»˜è®¤é€‰ä¸­
  if (currentId) sel.value = currentId;
  const hasProject = !!currentId;
  document.getElementById("topDeleteBtn").classList.toggle("show", hasProject);
}

// åˆ‡æ¢é¡¹ç›®
function switchProject() {
  currentId = document.getElementById("projectSelector").value;
  if (!currentId) {
	BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
	renderAll();
	goStep(1);
	return;
  }
  BOOK = JSON.parse(JSON.stringify(globalData.projects[currentId].data));
  renderAll();
  goStep(globalData.projects[currentId].step || 1);
  updateChapNumInput();
  renderSelect();
}

// æ–°å»ºå¼¹çª—
function newProjectModal() {
  document.getElementById("newName").value = "";
  document.getElementById("newModal").classList.add("active");
}
function hideNewModal() {
  document.getElementById("newName").value = "";
  document.getElementById("newModal").classList.remove("active");
}

// åˆ›å»ºé¡¹ç›®
function createCleanProject() {
  let name = document.getElementById("newName").value.trim();
  if (!name) return alert("è¯·è¾“å…¥é¡¹ç›®å");
  let id = "p" + Date.now();
  globalData.projects[id] = {
	name: name,
	step: 1,
	data: JSON.parse(JSON.stringify(DEFAULT_BOOK))
  };
  saveGlobal();
  hideNewModal();
  currentId = id;
  BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
  renderSelect();
  renderAll();
  goStep(1);
}

// åˆ é™¤é¡¹ç›®
function showDelModal() { document.getElementById("delModal").classList.add("active") }
function hideDelModal() { document.getElementById("delModal").classList.remove("active") }
function deleteProjectForever() {
  if (!currentId) return;
  delete globalData.projects[currentId];
  saveGlobal();
  currentId = null;
  BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
  renderSelect();
  renderAll();
  goStep(1);
  hideDelModal();
  alert("é¡¹ç›®å·²å½»åº•åˆ é™¤ï¼");
}

// åˆ é™¤ç« èŠ‚
function showDelChapterModal(chapNum) {
  document.getElementById("delChapterNum").value = chapNum;
  document.getElementById("delChapterModal").classList.add("active");
}
function hideDelChapterModal() {
  document.getElementById("delChapterNum").value = "";
  document.getElementById("delChapterModal").classList.remove("active");
}
function deleteChapterForever() {
  const chapNum = document.getElementById("delChapterNum").value;
  if (!chapNum) return;
  BOOK.contents = BOOK.contents.filter(c => c.num != chapNum);
  renderAll();
  saveNow();
  hideDelChapterModal();
  alert(`ç¬¬${chapNum}ç« å·²åˆ é™¤ï¼`);
}

// ç»†çº²ä½“é‡æ ¡éªŒå¼¹çª—
function showVolumeCheckModal(estimated, target) {
  document.getElementById("estimatedWords").textContent = estimated + "å­—";
  document.getElementById("targetWords").textContent = target + "å­—";
  document.getElementById("volumeCheckModal").classList.add("active");
}
function hideVolumeCheckModal() {
  document.getElementById("volumeCheckModal").classList.remove("active");
}

// æ ¸å¿ƒè®¾å®šæå–æç¤ºå¼¹çª—
function showSettingExtractModal(count) {
  document.getElementById("extractChapterCount").textContent = count;
  document.getElementById("settingExtractModal").classList.add("active");
}
function hideSettingExtractModal() {
  document.getElementById("settingExtractModal").classList.remove("active");
}

// è®¾ç½®å¼¹çª—
function toggleSet() {
  document.getElementById("apiKey").value = globalData.api || "";
  document.getElementById("model").value = globalData.model || "deepseek-chat";
  document.getElementById("temp").value = globalData.temp || 0.7;
  document.getElementById("maxTokens").value = globalData.maxTokens || 2048;
  document.getElementById("extractInterval").value = globalData.extractInterval || 50;
  document.getElementById("setModal").classList.toggle("active");
}
function saveApi() {
  globalData.api = document.getElementById("apiKey").value.trim();
  globalData.model = document.getElementById("model").value.trim();
  globalData.temp = parseFloat(document.getElementById("temp").value) || 0.7;
  globalData.maxTokens = parseInt(document.getElementById("maxTokens").value) || 2048;
  globalData.extractInterval = parseInt(document.getElementById("extractInterval").value) || 50;
  saveGlobal();
  alert("APIè®¾ç½®ä¿å­˜æˆåŠŸï¼");
  document.getElementById("setModal").classList.remove("active");
}

// æ­¥éª¤åˆ‡æ¢ï¼ˆæ— ç« çº²è‡ªåŠ¨æ£€æµ‹ï¼‰
function goStep(s) {
  const stepCheck = {
	2: () => !!BOOK.core,
	3: () => !!BOOK.outline.trim(),
	4: () => !!BOOK.detail.trim(),
	5: () => !!BOOK.zhang.trim(),
	6: () => BOOK.contents.length > 0
  };
  if (stepCheck[s] && !stepCheck[s]()) {
	const tips = {
	  2: "è¯·å…ˆç”Ÿæˆå¹¶é€‰æ‹©æ•…äº‹æ ¸",
	  3: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™å¤§çº²",
	  4: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™ç»†çº²",
	  5: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™ç« çº²",
	  6: "è¯·å…ˆç”Ÿæˆè‡³å°‘ä¸€ç« æ­£æ–‡"
	};
	alert(tips[s]);
	return;
  }

  document.querySelectorAll(".step-page").forEach(p => p.classList.add("hide"));
  document.querySelectorAll(".nav").forEach(n => n.classList.remove("active"));
  document.getElementById(`step${s}`).classList.remove("hide");
  document.querySelector(`.nav[data-step="${s}"]`).classList.add("active");
  currentStep = s;
  document.getElementById("backBtn").disabled = s === 1;
  if (s === 1 && BOOK.core) {
	document.getElementById("next1Left").classList.remove("hide");
	document.getElementById("next1Right").classList.remove("hide");
  } else {
	document.getElementById("next1Left").classList.add("hide");
	document.getElementById("next1Right").classList.add("hide");
  }
  if (currentId) globalData.projects[currentId].step = s;
  saveGlobal();
}

// è¿”å›ä¸Šä¸€æ­¥
function goPrevStep() {
  if (currentStep <= 1) return;
  goStep(currentStep - 1);
}

// æ•°æ®ä¿å­˜
function saveGlobal() { localStorage.setItem("writeData", JSON.stringify(globalData)) }
function saveNow() {
  if (!currentId) return;
  BOOK.idea = document.getElementById("idea").value;
  BOOK.view = document.getElementById("viewSelect").value;
  BOOK.style = document.getElementById("styleSelect").value;
  BOOK.total = parseFloat(document.getElementById("totalWan").value) || 0.5;
  BOOK.outline = document.getElementById("outline").value;
  BOOK.detail = document.getElementById("detail").value;
  BOOK.zhang = document.getElementById("zhang").value;
  globalData.projects[currentId].data = JSON.parse(JSON.stringify(BOOK));
  saveGlobal();
  updateOutlineWordCount();
  updateDetailWordCount();
  updateZhangWordCount();
}

// å­—æ•°ç»Ÿè®¡å‡½æ•°
function countChineseWords(text) {
  if (!text) return 0;
  const chineseChars = text.match(/[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]/g);
  return chineseChars ? chineseChars.length : 0;
}

// å¤§çº²/ç»†çº²/ç« çº²å­—æ•°ç»Ÿè®¡æ›´æ–°
function updateOutlineWordCount() {
  const count = countChineseWords(document.getElementById("outline").value);
  document.getElementById("outlineWordCount").textContent = `å­—æ•°: ${count}`;
}
function updateDetailWordCount() {
  const count = countChineseWords(document.getElementById("detail").value);
  document.getElementById("detailWordCount").textContent = `å­—æ•°: ${count}`;
}
function updateZhangWordCount() {
  const count = countChineseWords(document.getElementById("zhang").value);
  document.getElementById("zhangWordCount").textContent = `å­—æ•°: ${count}`;
}

// æ›´æ–°ç« èŠ‚å·è¾“å…¥æ¡†
function updateChapNumInput() {
  if (BOOK.contents.length === 0) {
	document.getElementById("chapNum").value = 1;
	return;
  }
  const maxNum = Math.max(...BOOK.contents.map(c => parseInt(c.num)));
  document.getElementById("chapNum").value = maxNum + 1;
}

// ç« çº²å»ºè®®æ•°è®¡ç®—ï¼ˆä»…å¤§çº²æ­¥éª¤æ˜¾ç¤ºï¼‰
function updateChapterSuggestion() {
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0;
  if (totalWan <= 0) {
	document.getElementById("chapterSuggestion").classList.add("hide");
	return;
  }
  const totalWords = Math.round(totalWan * 10000);
  const avgWordsPerChapter = 1500;
  const suggestedChapters = Math.round(totalWords / avgWordsPerChapter);
  const minChapters = Math.max(1, Math.floor(suggestedChapters * 0.8));
  const maxChapters = Math.ceil(suggestedChapters * 1.2);
  const suggestionText = `ğŸ’¡ å»ºè®®ç« çº²æ•°ï¼š${minChapters}-${maxChapters} ç« ï¼ˆæ¯ç« çº¦${avgWordsPerChapter}å­—ï¼Œç›®æ ‡æ€»å­—æ•°çº¦${totalWords}å­—ï¼‰`;
  document.getElementById("chapterSuggestion").textContent = suggestionText;
  document.getElementById("chapterSuggestion").classList.remove("hide");
}

// å¤åˆ¶åŠŸèƒ½ï¼ˆå¤§çº²/ç»†çº²/ç« çº²/å•ç« /å…¨ç« ï¼‰
function copyOutline() {
  const text = document.getElementById("outline").value.trim();
  if (!text) return alert("å¤§çº²å†…å®¹ä¸ºç©ºï¼");
  copyToClipboard(text, "å¤§çº²");
}
function copyDetail() {
  const text = document.getElementById("detail").value.trim();
  if (!text) return alert("ç»†çº²å†…å®¹ä¸ºç©ºï¼");
  copyToClipboard(text, "ç»†çº²");
}
function copyZhang() {
  const text = document.getElementById("zhang").value.trim();
  if (!text) return alert("ç« çº²å†…å®¹ä¸ºç©ºï¼");
  copyToClipboard(text, "ç« çº²");
}
function copyToClipboard(text, name) {
  if (navigator.clipboard && window.isSecureContext) {
	navigator.clipboard.writeText(text).then(() => {
	  alert(`âœ… ${name}å·²å¤åˆ¶ï¼`);
	}).catch(err => {
	  fallbackCopy(text, name);
	});
  } else {
	fallbackCopy(text, name);
  }
}
function fallbackCopy(text, name) {
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.style.position = "fixed";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.select();
  try {
	document.execCommand("copy");
	alert(`âœ… ${name}å·²å¤åˆ¶ï¼`);
  } catch (err) {
	alert(`âš ï¸ ${name}å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼`);
  } finally {
	document.body.removeChild(textarea);
  }
}
function copyChapter(btn, chapNum) {
  const content = btn.closest(".chapter-item").querySelector(".chapter-content").textContent;
  const text = `ç¬¬${chapNum}ç« \n${content}`;
  copyToClipboard(text, `ç¬¬${chapNum}ç« `);
}
function copyAllText() {
  if (BOOK.contents.length === 0) return alert("æš‚æ— æ­£æ–‡å¯å¤åˆ¶ï¼");
  let text = "";
  BOOK.contents.forEach(c => {
	text += `ç¬¬${c.num}ç« \n${c.content}\n\n`;
  });
  copyToClipboard(text, `æ‰€æœ‰${BOOK.contents.length}ç« `);
}

// æ¸²æŸ“æ‰€æœ‰å†…å®¹ï¼ˆå«å‰©ä½™ç« èŠ‚è®¡ç®—ï¼‰
function renderAll() {
  document.getElementById("idea").value = BOOK.idea || "";
  document.getElementById("viewSelect").value = BOOK.view || "ç¬¬ä¸‰äººç§°";
  document.getElementById("styleSelect").value = BOOK.style || "å°ç™½ç›´ç™½çˆ½æ–‡";
  document.getElementById("totalWan").value = BOOK.total || 0.5;
  document.getElementById("outline").value = BOOK.outline || "";
  document.getElementById("detail").value = BOOK.detail || "";
  document.getElementById("zhang").value = BOOK.zhang || "";
  
  updateChapterSuggestion();
  
  let res = document.getElementById("resultWrite");
  res.innerHTML = "";
  let totalWords = 0;
  
  // æ¸²æŸ“ç« èŠ‚ï¼ˆå¸¦æŠ˜å /åˆ é™¤/å­—æ•°ï¼‰
  BOOK.contents.forEach(c => {
	const chapWords = countChineseWords(c.content);
	totalWords += chapWords;
	let div = document.createElement("div");
	div.className = "chapter-item";
	div.innerHTML = `
	  <div class="chapter-header">
		<div class="chapter-left">
		  <div class="chapter-num">ç¬¬${c.num}ç« </div>
		  <div class="chapter-toggle-btn" onclick="toggleChapter(this)">æ”¶èµ·</div>
		  <div class="chapter-single-word">æœ¬ç« å­—æ•°: ${chapWords}</div>
		</div>
		<div class="chapter-operate">
		  <div class="chapter-copy-btn" onclick="copyChapter(this, '${c.num}')">å¤åˆ¶æœ¬ç« </div>
		  <div class="chapter-delete-btn" onclick="showDelChapterModal('${c.num}')">ğŸ—‘ï¸ åˆ é™¤</div>
		</div>
	  </div>
	  <div class="chapter-content">${c.content.replace(/\n/g, "<br>")}</div>
	  <div class="chapter-footer">
		<div class="chapter-toggle-btn" onclick="toggleChapter(this.closest('.chapter-item').querySelector('.chapter-header .chapter-toggle-btn'))">æ”¶èµ·æœ¬ç« </div>
	  </div>
	`;
	res.appendChild(div);
  });
  
  // æ›´æ–°æ€»å­—æ•°+å‰©ä½™ç« èŠ‚æç¤ºã€æ ¸å¿ƒï¼šæ­£æ–‡å…±éœ€ç« èŠ‚æ•° = ç« çº²å®é™…ç« èŠ‚æ•°ã€‘
  document.getElementById("totalWordWrap").textContent = `æ€»å­—æ•°: ${totalWords}`;
  // ä»ç« çº²ä¸­è§£æå®é™…ç« èŠ‚æ•°ï¼ˆåŒ¹é…ç« çº²æ ¼å¼ï¼š**ç¬¬Xç« ï¼‰
  function getChapterCountFromZhang() {
	if (!BOOK.zhang.trim()) return 0;
	const chapterRegex = /\*\*ç¬¬\d+ç« /g;
	const chapterMatches = BOOK.zhang.match(chapterRegex);
	return chapterMatches ? chapterMatches.length : 0;
  }
  const totalChapterNeed = getChapterCountFromZhang(); // ä»…è®¤ç« çº²æ•°
  const chapterGenerated = BOOK.contents.length;
  const chapterRemain = Math.max(0, totalChapterNeed - chapterGenerated);
  document.getElementById("chapterRemainTip").textContent = `å·²ç”Ÿæˆ${chapterGenerated}ç«  / å…±éœ€${totalChapterNeed}ç« ï¼Œè¿˜å‰©${chapterRemain}ç« `;
  
  // æ›´æ–°ä¿®æ”¹ç« èŠ‚ä¸‹æ‹‰
  let sel = document.getElementById("editChap");
  sel.innerHTML = '<option value="">é€‰ç« èŠ‚</option>';
  BOOK.contents.forEach(c => {
	let opt = document.createElement("option");
	opt.value = c.num;
	opt.textContent = `ç¬¬${c.num}ç« `;
	sel.appendChild(opt);
  });
  
  updateChapNumInput();
  updateOutlineWordCount();
  updateDetailWordCount();
  updateZhangWordCount();
}

// ç« èŠ‚æŠ˜å /å±•å¼€ï¼ˆé¡¶éƒ¨+åº•éƒ¨æŒ‰é’®è”åŠ¨ï¼‰
function toggleChapter(btn) {
  const chapterItem = btn.closest(".chapter-item");
  const content = chapterItem.querySelector(".chapter-content");
  const allToggleBtns = chapterItem.querySelectorAll(".chapter-toggle-btn");
  if (content.style.display === "none") {
	content.style.display = "block";
	allToggleBtns.forEach(b => b.textContent = "æ”¶èµ·");
  } else {
	content.style.display = "none";
	allToggleBtns.forEach(b => b.textContent = "å±•å¼€");
  }
}

// è¿›åº¦æ¡æ§åˆ¶
function startProgress(barId) {
  if (progressTimer) clearInterval(progressTimer);
  const progressBar = document.getElementById(barId);
  progressBar.style.width = "0%";
  let currentProgress = 0;
  progressTimer = setInterval(() => {
	if (currentProgress >= 95) return;
	const step = Math.random() * 3 + 1;
	currentProgress += step;
	progressBar.style.width = `${currentProgress}%`;
  }, 200);
}
function resetProgress(barId) {
  if (progressTimer) clearInterval(progressTimer);
  const progressBar = document.getElementById(barId);
  progressBar.style.width = "100%";
  setTimeout(() => {
	progressBar.style.width = "0%";
  }, 300);
}

// AIè¯·æ±‚åŸºç¡€å‡½æ•°ï¼ˆåµŒå…¥æ ¸å¿ƒè®¾å®šï¼‰
async function aiRequest(system, user, needEmbedSetting = true) {
  if (!globalData.api) {
	alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™æœ‰æ•ˆçš„API Keyï¼");
	throw new Error("æœªé…ç½®API Key");
  }
  let finalSystem = system;
  if (needEmbedSetting && BOOK.coreSettings && Object.keys(BOOK.coreSettings).length > 0) {
	const settingText = `
	  æ ¸å¿ƒè®¾å®šçº¦æŸï¼š
	  1. äººç‰©è®¾å®šï¼š${BOOK.coreSettings.characters.length > 0 ? BOOK.coreSettings.characters.join("ï¼›") : "æ— "}
	  2. ä¸–ç•Œè§‚ï¼š${BOOK.coreSettings.worldView || "æ— "}
	  3. æ ¸å¿ƒå†²çªï¼š${BOOK.coreSettings.coreConflict || "æ— "}
	  4. é£æ ¼çº¦æŸï¼š${BOOK.coreSettings.styleConstraint || "æ— "}
	  å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸Šæ ¸å¿ƒè®¾å®šï¼Œä¸å¾—åç¦»ï¼
	`.trim();
	finalSystem = `${finalSystem}\n\n${settingText}`;
  }
  try {
	let res = await fetch("https://api.deepseek.com/v1/chat/completions", {
	  method: "POST",
	  headers: { "Authorization": "Bearer " + globalData.api, "Content-Type": "application/json" },
	  body: JSON.stringify({
		model: globalData.model,
		messages: [{ role: "system", content: finalSystem }, { role: "user", content: user }],
		temperature: globalData.temp,
		max_tokens: globalData.maxTokens,
		stream: false
	  })
	});
	if (!res.ok) {
	  let errorData = await res.json().catch(() => ({}));
	  throw new Error(`APIè¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${res.status}ï¼‰ï¼š${errorData.message || "ç½‘ç»œå¼‚å¸¸"}`);
	}
	let data = await res.json();
	if (data.error) throw new Error(data.error.message);
	return data.choices[0].message.content;
  } catch (e) {
	alert("AIè¯·æ±‚å¤±è´¥ï¼š" + e.message);
	throw e;
  }
}

// ç”Ÿæˆæ•…äº‹æ ¸
async function genCore() {
  const idea = document.getElementById("idea").value.trim();
  if (!idea) return alert("è¯·è¾“å…¥çµæ„Ÿ/å…³é”®è¯");
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step1 .btn-primary");
  genBtn.disabled = true;
  const loading = document.getElementById("coreLoading");
  loading.classList.remove("hide");
  startProgress("coreProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´æ•…äº‹æ ¸å†™æ‰‹ï¼Œä¸¥æ ¼ç”Ÿæˆ5ä¸ªä¸åŒçš„é€‰é¡¹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›ç”¨æ—¥å¸¸å¸¸è§çš„æ¯”å–»ï¼Œæ‹’ç»ç”Ÿåƒ»/å¥‡æ€ªæ¯”å–»ï¼Œå‡å°‘è¿‡åº¦åä¸½ä¿®é¥°ï¼Œèšç„¦æ ¸å¿ƒå†²çªï¼Œè¯­è¨€è´´è¿‘çœŸäººæ‰‹å†™é£æ ¼ï¼Œæ— AIåˆ»æ¿æ„Ÿã€‚`,
	  `æ ¹æ®çµæ„Ÿå…³é”®è¯ç”Ÿæˆ5ä¸ª${style}é£æ ¼çš„${view}æ•…äº‹æ ¸é€‰é¡¹ï¼Œæ¯ä¸ªä¸è¶…è¿‡100å­—ï¼Œç”¨æ•°å­—ç¼–å·ï¼ˆ1. 2. 3. 4. 5.ï¼‰ï¼š${idea}`,
	  false
	);
	const coreList = result.split(/\n+/)
	  .filter(item => item.trim() && /^\d+\./.test(item))
	  .map(item => item.replace(/^\d+\./, "").trim());
	while (coreList.length < 5) {
	  coreList.push(`${idea}ï¼ˆ${view}/${style}é£æ ¼ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰`);
	}
	document.getElementById("coreGrid").innerHTML = coreList.map((item, idx) => `
	  <div class="core-card" onclick="selectCore('${idx}')">
		<div class="core-title">æ•…äº‹æ ¸${idx+1}</div>
		<div>${item}</div>
	  </div>
	`).join("");
	document.getElementById("coreGrid").classList.remove("hide");
  } catch (e) {
	console.error("ç”Ÿæˆæ•…äº‹æ ¸å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
	resetProgress("coreProgressBar");
  }
}

// é€‰æ‹©æ•…äº‹æ ¸
function selectCore(idx) {
  const coreCards = document.querySelectorAll(".core-card");
  coreCards.forEach((card, i) => {
	card.classList.toggle("active", i == idx);
  });
  BOOK.core = coreCards[idx].querySelector("div:last-child").textContent;
  saveNow();
  document.getElementById("next1Left").classList.remove("hide");
  document.getElementById("next1Right").classList.remove("hide");
}

// ç”Ÿæˆå¤§çº²
async function genOutline() {
  if (!BOOK.core) return alert("è¯·å…ˆé€‰æ‹©æ•…äº‹æ ¸");
  const totalWan = document.getElementById("totalWan").value;
  const totalWords = Math.round(totalWan * 10000);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step2 .btn-primary");
  genBtn.disabled = true;
  const loading = document.getElementById("outlineLoading");
  loading.classList.remove("hide");
  startProgress("outlineProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´å¤§çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›å¿…é¡»ç”Ÿæˆè¯¦ç»†å¤§çº²ï¼Œåˆ†4-6ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µåŒ…å«3-4ä¸ªæ ¸å¿ƒæƒ…èŠ‚ï¼Œæ¯ä¸ªæƒ…èŠ‚æ˜ç¡®æ—¶é—´ã€åœºæ™¯ã€æ ¸å¿ƒå†²çªï¼Œç”¨é€šä¿—ç›´ç™½çš„è¯­è¨€ï¼Œä¸ç”¨ç”Ÿåƒ»æ¯”å–»å’Œè¿‡åº¦ä¿®é¥°ï¼Œç¬¦åˆç½‘ç»œå°è¯´èŠ‚å¥ï¼Œæ— AIå‘³ï¼›ç”Ÿæˆåå¿…é¡»ä¸¥æ ¼éµå¾ªï¼Œä¸å¾—é—æ¼ä»»ä½•é˜¶æ®µå’Œæƒ…èŠ‚ã€‚`,
	  `æ ¹æ®æ•…äº‹æ ¸ç”Ÿæˆ${totalWan}ä¸‡å­—ï¼ˆçº¦${totalWords}å­—ï¼‰çš„${style}é£æ ¼${view}å°è¯´è¯¦ç»†å¤§çº²ï¼Œæ¯ä¸ªé˜¶æ®µè¯´æ˜æ ¸å¿ƒå†²çªã€æƒ…èŠ‚èµ°å‘ã€å…³é”®åœºæ™¯ï¼Œæ¯ä¸ªé˜¶æ®µä¸å°‘äº3ä¸ªæ ¸å¿ƒæƒ…èŠ‚ï¼š${BOOK.core}`,
	  false
	);
	document.getElementById("outline").value = result;
	BOOK.outline = result;
	saveNow();
	alert("å¤§çº²ç”ŸæˆæˆåŠŸï¼");
  } catch (e) {
	console.error("ç”Ÿæˆå¤§çº²å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
	resetProgress("outlineProgressBar");
  }
}

// ç”Ÿæˆç»†çº²ï¼ˆå«ä½“é‡æ ¡éªŒï¼‰
async function genDetail() {
  if (!BOOK.outline.trim()) return alert("è¯·å…ˆå¡«å†™å¤§çº²");
  const totalWan = document.getElementById("totalWan").value;
  const targetWords = Math.round(totalWan * 10000);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step3 .btn-primary");
  genBtn.disabled = true;
  const loading = document.getElementById("detailLoading");
  loading.classList.remove("hide");
  startProgress("detailProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ç»†çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›å¿…é¡»å°†å¤§çº²æ‹†è§£ä¸ºè¯¦ç»†å…³é”®èŠ‚ç‚¹ï¼Œæ¯ä¸ªé˜¶æ®µæ‹†åˆ†ä¸º4-5ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¿…é¡»æ˜ç¡®ï¼š1.æ—¶é—´ 2.åœºæ™¯ 3.äººç‰©è¡Œä¸º 4.æƒ…èŠ‚ç”¨é€”ï¼ˆæ¨åŠ¨å‰§æƒ…/é“ºå«ä¼ç¬”/æ­éœ²ä¿¡æ¯ï¼‰ï¼Œæ¯èŠ‚ç‚¹ä¸è¶…80å­—ï¼Œé€»è¾‘é€’è¿›ï¼Œæ— AIå‘³ï¼›ç”Ÿæˆçš„ç»†çº²éœ€è®©AIåç»­ç”Ÿæˆæ­£æ–‡æ—¶ç™¾åˆ†ç™¾éµå¾ªï¼Œä¸å¾—é—æ¼ä»»ä½•èŠ‚ç‚¹ç»†èŠ‚ã€‚`,
	  `å°†ä»¥ä¸‹å¤§çº²æ‹†è§£ä¸º${style}é£æ ¼${view}è¯¦ç»†ç»†çº²ï¼Œä¸¥æ ¼éµå®ˆæ¯ä¸ªèŠ‚ç‚¹çš„4é¡¹è¦æ±‚ï¼Œä¸å¾—é—æ¼å¤§çº²ä»»ä½•æƒ…èŠ‚ï¼š\n\n${BOOK.outline}`,
	  false
	);
	// ä¼°ç®—ç»†çº²å­—æ•°ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æŒ‰150å­—æ­£æ–‡å±•å¼€ï¼‰
	const nodeCount = result.split(/\n+/).filter(line => line.trim() && /^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+\./.test(line)).length;
	const estimatedWords = Math.round(nodeCount * 150);
	// åå·®æ ¡éªŒï¼ˆè¶…20%å¼¹å‡ºæç¤ºï¼‰
	const deviation = Math.abs(estimatedWords - targetWords) / targetWords;
	if (deviation > 0.2) {
	  document.getElementById("detail").value = result;
	  BOOK.detail = result;
	  saveNow();
	  showVolumeCheckModal(estimatedWords, targetWords);
	} else {
	  document.getElementById("detail").value = result;
	  BOOK.detail = result;
	  saveNow();
	  alert("ç»†çº²ç”ŸæˆæˆåŠŸï¼");
	}
  } catch (e) {
	console.error("ç”Ÿæˆç»†çº²å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
	resetProgress("detailProgressBar");
  }
}

// é€‚é…ç›®æ ‡å­—æ•°ä¼˜åŒ–ç»†çº²
async function optimizeDetailByTarget() {
  const totalWan = document.getElementById("totalWan").value;
  const targetWords = Math.round(totalWan * 10000);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const loading = document.createElement("div");
  loading.className = "loading";
  loading.textContent = "æ­£åœ¨ä¼˜åŒ–ç»†çº²...";
  document.querySelector("#step3 .step-box").appendChild(loading);

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ç»†çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›æ ¹æ®ç›®æ ‡æ€»å­—æ•°${targetWords}å­—ï¼ˆæ¯ç« çº¦1500å­—ï¼‰ï¼Œä¼˜åŒ–ç»†çº²èŠ‚ç‚¹æ•°é‡å’Œå†…å®¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»éœ€æ˜ç¡®1.æ—¶é—´ 2.åœºæ™¯ 3.äººç‰©è¡Œä¸º 4.æƒ…èŠ‚ç”¨é€”ï¼Œç¡®ä¿æ€»ä½“é‡åŒ¹é…ç›®æ ‡å­—æ•°ï¼Œæ— AIå‘³ï¼Œä¸å¾—é—æ¼æ ¸å¿ƒæƒ…èŠ‚ã€‚`,
	  `ä¼˜åŒ–ä»¥ä¸‹ç»†çº²ï¼Œä½¿å…¶é€‚é…ç›®æ ‡æ€»å­—æ•°${targetWords}å­—ï¼š\n\n${BOOK.detail}`,
	  false
	);
	document.getElementById("detail").value = result;
	BOOK.detail = result;
	saveNow();
	alert("ç»†çº²ä¼˜åŒ–æˆåŠŸï¼å·²é€‚é…ç›®æ ‡å­—æ•°");
  } catch (e) {
	console.error("ä¼˜åŒ–ç»†çº²å¤±è´¥ï¼š", e);
	alert("ä¼˜åŒ–ç»†çº²å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
  } finally {
	loading.remove();
	hideVolumeCheckModal();
  }
}

// AIæ‰‹åŠ¨æ ¡éªŒç»†çº²ä½“é‡ï¼šåˆ¤æ–­èƒ½å¦æ”¯æ’‘ç›®æ ‡å­—æ•°ï¼ˆä»…ä¿ç•™1ä¸ªå®šä¹‰ï¼Œä¿®å¤è¯­æ³•ï¼‰
async function autoCheckDetailVolume() {
  if (!BOOK.detail.trim()) return alert("è¯·å…ˆå¡«å†™ç»†çº²");
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0.5;
  const targetWords = Math.round(totalWan * 10000);
  const view = BOOK.view;
  const style = BOOK.style;

  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œéšè—æ‰€æœ‰æŒ‰é’®
  document.getElementById("checkLoading").classList.remove("hide");
  document.getElementById("zhangGenBtnGroup").style.display = "none";
  document.getElementById("backToDetailBtnGroup").style.display = "none";
  document.getElementById("detailVolumeCheckResult").classList.add("hide");

  startProgress("checkProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ä½“é‡æ ¡éªŒåŠ©æ‰‹ï¼Œä»…éœ€å®Œæˆ2ä»¶äº‹ï¼š1. åˆ†æä»¥ä¸‹ç»†çº²çš„èŠ‚ç‚¹æ•°é‡ã€æƒ…èŠ‚å¯†åº¦ï¼ŒæŒ‰${view}/${style}é£æ ¼ã€1500å­—/ç« çš„ç½‘æ–‡å¸¸è§„èŠ‚å¥ï¼Œç²¾å‡†ä¼°ç®—èƒ½æ”¯æ’‘çš„æ€»å†™ä½œå­—æ•°ï¼›2. å¯¹æ¯”ç›®æ ‡æ€»å­—æ•°${targetWords}å­—ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾æ ‡ï¼ˆåå·®â‰¤20%ä¸ºè¾¾æ ‡ï¼Œåå·®>20%ä¸ºä¸è¾¾æ ‡ï¼‰ï¼Œä»…è¾“å‡ºç»“è®ºï¼Œæ ¼å¼ä¸¥æ ¼éµå¾ªï¼š"é¢„ä¼°å¯å†™å­—æ•°ï¼šXXXå­—ï¼Œæ˜¯å¦è¾¾æ ‡ï¼šæ˜¯/å¦ï¼Œå»ºè®®ï¼šXXX"ï¼Œä¸ç”¨é¢å¤–è§£é‡Šï¼Œä¸æ·»åŠ ä»»ä½•å¤šä½™å†…å®¹ã€‚`,
	  `éœ€è¦æ ¡éªŒçš„ç»†çº²å†…å®¹ï¼š\n\n${BOOK.detail}`,
	  false
	);

	// ä¸¥æ ¼è§£æAIè¿”å›çš„ç»“è®º
	const estimatedMatch = result.match(/é¢„ä¼°å¯å†™å­—æ•°ï¼š(\d+)å­—/);
	const isQualifiedMatch = result.match(/æ˜¯å¦è¾¾æ ‡ï¼š(æ˜¯|å¦)/);
	const suggestionMatch = result.match(/å»ºè®®ï¼š(.+)/);

	const estimatedWords = estimatedMatch ? parseInt(estimatedMatch[1]) : 0;
	const isQualified = isQualifiedMatch ? isQualifiedMatch[1] === "æ˜¯" : false;
	const suggestion = suggestionMatch ? suggestionMatch[1] : "è¯·æ ¹æ®æƒ…èŠ‚å¯†åº¦è¡¥å……æˆ–ç²¾ç®€ç»†çº²èŠ‚ç‚¹";

	// è®¡ç®—åå·®ç‡å¹¶æ ¼å¼åŒ–
	const deviation = estimatedWords > 0 ? Math.abs(estimatedWords - targetWords) / targetWords : 1;
	const deviationText = (deviation * 100).toFixed(1) + "%";

	// æ¸²æŸ“æ ¡éªŒç»“æœå’Œå¯¹åº”æŒ‰é’®
	const resultElem = document.getElementById("detailVolumeCheckResult");
	if (isQualified) {
	  resultElem.innerHTML = `âœ… ç»†çº²ä½“é‡è¾¾æ ‡ï¼é¢„ä¼°å¯å†™${estimatedWords}å­—ï¼ˆç›®æ ‡${targetWords}å­—ï¼Œåå·®${deviationText}ï¼‰ï¼Œå¯ç›´æ¥ç”Ÿæˆç« çº²ã€‚`;
	  resultElem.style.background = "rgba(16,185,129,0.1)";
	  document.getElementById("zhangGenBtnGroup").style.display = "flex";
	} else {
	  resultElem.innerHTML = `âš ï¸ ç»†çº²ä½“é‡ä¸åŒ¹é…ï¼é¢„ä¼°å¯å†™${estimatedWords}å­—ï¼ˆç›®æ ‡${targetWords}å­—ï¼Œåå·®${deviationText}ï¼‰ï¼Œ${suggestion}ã€‚`;
	  resultElem.style.background = "rgba(245,158,11,0.1)";
	  document.getElementById("backToDetailBtnGroup").style.display = "flex";
	}
	resultElem.classList.remove("hide");

  } catch (e) {
	console.error("æ ¡éªŒç»†çº²ä½“é‡å¤±è´¥ï¼š", e);
	const resultElem = document.getElementById("detailVolumeCheckResult");
	resultElem.innerHTML = `âš ï¸ æ ¡éªŒå¤±è´¥ï¼${e.message.slice(0, 60)}ï¼Œè¯·è¿”å›ç»†çº²æ‰‹åŠ¨ä¿®æ”¹åé‡è¯•ã€‚`;
	resultElem.style.background = "rgba(255,68,68,0.1)";
	resultElem.classList.remove("hide");
	document.getElementById("backToDetailBtnGroup").style.display = "flex";
  } finally {
	document.getElementById("checkLoading").classList.add("hide");
	resetProgress("checkProgressBar");
  }
}

// ç”Ÿæˆç« çº²ï¼ˆæœªæ”¾å®½ä»£ç é™åˆ¶ï¼Œå¼ºåŒ–AIå¼ºåˆ¶æ‹†åˆ†èŠ‚ç‚¹ï¼‰
async function genZhang() {
  if (!BOOK.detail.trim()) return alert("è¯·å…ˆå¡«å†™ç»†çº²");
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0.5;
  const totalWords = Math.round(totalWan * 10000);
  const avgWordsPerChapter = 1500;
  const suggestedChapters = Math.round(totalWords / avgWordsPerChapter);
  // ä¸¥æ ¼ä¿ç•™åŸä»£ç é™åˆ¶ï¼šÂ±20%
  const minChapters = Math.max(1, Math.floor(suggestedChapters * 0.8));
  const maxChapters = Math.ceil(suggestedChapters * 1.2);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step4 .btn-primary");
  genBtn.disabled = true;
  const loading = document.getElementById("zhangLoading");
  loading.classList.remove("hide");
  startProgress("zhangProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ä¸“ä¸šç½‘ç»œå°è¯´ç« çº²å†™æ‰‹ï¼Œä¸¥æ ¼éµå¾ª${view}è§†è§’ã€${style}é£æ ¼ï¼Œ**å¿…é¡»ä¸¥æ ¼æŒ‰è¦æ±‚æ‹†åˆ†ç« èŠ‚ï¼Œæœªè¾¾æ ‡ç›´æ¥åˆ¤å®šç”Ÿæˆå¤±è´¥**ï¼
	  æ ¸å¿ƒè¦æ±‚1ï¼šæ€»å­—æ•°é€‚é…${totalWords}å­—ï¼Œå¿…é¡»ç”Ÿæˆ${minChapters}-${maxChapters}ç« ç« çº²ï¼Œå°‘ä¸€ç« ã€å¤šä¸€ç« éƒ½ä¸è¡Œï¼›
	  æ ¸å¿ƒè¦æ±‚2ï¼š**å°†ç»†çº²çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹å¼ºåˆ¶æ‹†åˆ†ä¸º1-2ä¸ªç‹¬ç«‹ç« èŠ‚**ï¼Œç»†çº²æœ‰å¤šå°‘èŠ‚ç‚¹ï¼Œå°±å¯¹åº”æ‹†å‡ºå¤šå°‘ç« èŠ‚ï¼Œç¦æ­¢åˆå¹¶èŠ‚ç‚¹æˆå¤§ç« ï¼›
	  æ ¸å¿ƒè¦æ±‚3ï¼šæ¯ç« çº¦${avgWordsPerChapter}å­—ï¼Œä»¥"**ç¬¬Xç«  æ ‡é¢˜**"å¼€å¤´ï¼Œå†…å®¹åŒ…å«æ ¸å¿ƒåœºæ™¯ã€æ ¸å¿ƒåŠ¨ä½œã€å¯¹åº”ç»†çº²èŠ‚ç‚¹ä¼ç¬”ï¼Œä¸è¶…120å­—ï¼Œæ— AIå‘³ï¼›
	  æ ¸å¿ƒè¦æ±‚4ï¼šä¸¥æ ¼éµå¾ªç»†çº²å†…å®¹ï¼Œç¦æ­¢æ–°å¢ä»»ä½•æœªæåŠçš„æƒ…èŠ‚ã€äººç‰©ã€è®¾å®šï¼Œç™¾åˆ†ç™¾è´´åˆç»†çº²èŠ‚ç‚¹ã€‚`,
	  `æ ¹æ®ä»¥ä¸‹ç»†çº²ç”Ÿæˆç¬¦åˆè¦æ±‚çš„ç« çº²ï¼Œä¸¥æ ¼æŒ‰ç»†çº²èŠ‚ç‚¹1:1/1:2æ‹†åˆ†ï¼Œç« èŠ‚æ•°å¿…é¡»åœ¨${minChapters}-${maxChapters}ä¹‹é—´ï¼š\n\n${BOOK.detail}`,
	  false
	);
	// æ ¡éªŒç« çº²æ•°é‡ï¼ˆä¿ç•™åŸä»£ç ä¸¥æ ¼è§„åˆ™ï¼‰
	const chapterCount = result.split(/\n+/).filter(line => line.trim() && /^\*\*ç¬¬\d+ç« /.test(line)).length;
	if (chapterCount < minChapters || chapterCount > maxChapters) {
	  throw new Error(`ç« çº²æ•°é‡ä¸ç¬¦åˆè¦æ±‚ï¼ˆå½“å‰${chapterCount}ç« ï¼Œéœ€${minChapters}-${maxChapters}ç« ï¼‰`);
	}
	document.getElementById("zhang").value = result;
	BOOK.zhang = result;
	saveNow();
	alert(`ç« çº²ç”ŸæˆæˆåŠŸï¼å…±${chapterCount}ç« ï¼Œå®Œå…¨ç¬¦åˆæ•°é‡è¦æ±‚`);
  } catch (e) {
	console.error("ç”Ÿæˆç« çº²å¤±è´¥ï¼š", e);
	alert("ç”Ÿæˆç« çº²å¤±è´¥ï¼š" + e.message);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
	resetProgress("zhangProgressBar");
  }
}

// ç”Ÿæˆæ­£æ–‡ï¼ˆå­—æ•°é™åˆ¶+ä¸è¶…çº²+æ ¸å¿ƒè®¾å®šåµŒå…¥+å®šæœŸæå–ï¼‰
async function writeChap() {
  if (!BOOK.zhang.trim()) return alert("è¯·å…ˆå¡«å†™ç« çº²");
  const chapNum = document.getElementById("chapNum").value;
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0.5;
  const totalWords = Math.round(totalWan * 10000);
  const avgWordsPerChapter = 1500;
  const minWordPerChap = Math.round(avgWordsPerChapter * 0.8);
  const maxWordPerChap = Math.round(avgWordsPerChapter * 1.2);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step5 .btn-primary");
  genBtn.disabled = true;
  const loading = document.getElementById("chapLoading");
  loading.classList.remove("hide");
  startProgress("chapProgressBar");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´æ­£æ–‡å†™æ‰‹ï¼Œå¿…é¡»ç™¾åˆ†ç™¾éµå¾ªå¤§çº²ã€ç»†çº²ã€ç« çº²çš„æ‰€æœ‰è®¾å®šï¼ˆåŒ…æ‹¬æ—¶é—´ã€åœºæ™¯ã€äººç‰©è¡Œä¸ºã€ä¼ç¬”ç»†èŠ‚ã€ç¦æ­¢æ–°å¢å†…å®¹ï¼‰ï¼Œä¸å¾—é—æ¼ä»»ä½•æ˜ç¡®æ ‡æ³¨çš„æƒ…èŠ‚ã€çº¿ç´¢æˆ–äººç‰©èƒŒæ™¯ï¼Œç¦æ­¢æ–°å¢æœªæåŠçš„æŠ€èƒ½ã€è®¾å®šã€è§’è‰²æˆ–æƒ…èŠ‚ï¼›å†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›ç”¨æ—¥å¸¸å¸¸è§çš„æ¯”å–»ï¼Œå‡å°‘è¿‡åº¦åä¸½ä¿®é¥°ï¼Œèšç„¦ç« çº²æŒ‡å®šçš„æƒ…èŠ‚æ¨è¿›å’Œè§’è‰²åŠ¨ä½œï¼Œå¯¹è¯ç¬¦åˆé£æ ¼/è§†è§’ï¼Œè¯»èµ·æ¥åƒçœŸäººæ‰‹å†™ï¼›æ¯ç« å­—æ•°ä¸¥æ ¼æ§åˆ¶åœ¨${minWordPerChap}-${maxWordPerChap}å­—ï¼ˆä¸å¾—è¶…å‡ºï¼‰ï¼Œä¸è¶…çº²ã€ä¸å°‘çº²ã€‚`,
	  `æ ¹æ®ä»¥ä¸‹ç« çº²ç”Ÿæˆç¬¬${chapNum}ç« ${style}é£æ ¼${view}æ­£æ–‡ï¼Œä¸¥æ ¼éµå®ˆå­—æ•°èŒƒå›´${minWordPerChap}-${maxWordPerChap}å­—ï¼Œä¸å¾—é—æ¼ç»†çº²ä»»ä½•èŠ‚ç‚¹ç»†èŠ‚ï¼š\n\n${BOOK.zhang}`
	);
	// æ ¡éªŒæ­£æ–‡å­—æ•°
	const chapWords = countChineseWords(result);
	if (chapWords < minWordPerChap || chapWords > maxWordPerChap) {
	  throw new Error(`æ­£æ–‡å­—æ•°ä¸ç¬¦åˆè¦æ±‚ï¼ˆå½“å‰${chapWords}å­—ï¼Œéœ€${minWordPerChap}-${maxWordPerChap}å­—ï¼‰`);
	}
	// ä¿å­˜ç« èŠ‚
	const existing = BOOK.contents.find(c => c.num == chapNum);
	if (existing) {
	  existing.content = result;
	} else {
	  BOOK.contents.push({ num: chapNum, content: result });
	}
	renderAll();
	saveNow();
	alert(`ç¬¬${chapNum}ç« ç”ŸæˆæˆåŠŸï¼ï¼ˆ${chapWords}å­—ï¼Œç¬¦åˆå­—æ•°è¦æ±‚ï¼‰`);
	
	// å®šæœŸæå–æ ¸å¿ƒè®¾å®šï¼ˆæ¯Nç« ä¸€æ¬¡ï¼‰
	const extractInterval = globalData.extractInterval || 50;
	const chapterCount = BOOK.contents.length;
	if (chapterCount > 0 && chapterCount % extractInterval === 0) {
	  await extractCoreSettings(chapterCount);
	  showSettingExtractModal(chapterCount);
	}
  } catch (e) {
	console.error("ç”Ÿæˆæ­£æ–‡å¤±è´¥ï¼š", e);
	alert("ç”Ÿæˆæ­£æ–‡å¤±è´¥ï¼š" + e.message);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
	resetProgress("chapProgressBar");
	updateChapNumInput();
  }
}

// æå–æ ¸å¿ƒè®¾å®š
async function extractCoreSettings(chapterCount) {
  const view = BOOK.view;
  const style = BOOK.style;
  const allContent = BOOK.contents.map(c => `ç¬¬${c.num}ç« ï¼š${c.content}`).join("\n\n");
  
  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´æ ¸å¿ƒè®¾å®šæå–åŠ©æ‰‹ï¼Œä»ä»¥ä¸‹ç« èŠ‚å†…å®¹ä¸­æå–ç»“æ„åŒ–æ ¸å¿ƒè®¾å®šï¼Œè¯­è¨€ç®€æ´æ˜äº†ï¼Œä¸æ·»åŠ é¢å¤–å†…å®¹ï¼š
	  1. æ ¸å¿ƒäººç‰©ï¼šå§“åã€èº«ä»½ã€æ€§æ ¼ã€æ ¸å¿ƒåŠ¨æœºã€éšè—ç§˜å¯†ã€å…³é”®å…³ç³»ï¼ˆæ¯æ¡ä¸è¶…50å­—ï¼‰ï¼›
	  2. ä¸–ç•Œè§‚ï¼šæ•…äº‹èƒŒæ™¯ã€ç‰¹æ®Šè§„åˆ™ã€æ ¸å¿ƒè®¾å®šï¼ˆä¸è¶…100å­—ï¼‰ï¼›
	  3. æ ¸å¿ƒå†²çªï¼šä¸»çº¿å†²çªã€æœªè§£å†³çš„ä¼ç¬”ï¼ˆä¸è¶…100å­—ï¼‰ï¼›
	  4. é£æ ¼çº¦æŸï¼šå™äº‹è§†è§’ã€å†™ä½œé£æ ¼ã€ç¦æ­¢æ–°å¢çš„å†…å®¹ï¼ˆä¸è¶…50å­—ï¼‰ã€‚`,
	  `æå–ä»¥ä¸‹${chapterCount}ç« å†…å®¹çš„æ ¸å¿ƒè®¾å®šï¼š\n\n${allContent}`,
	  false
	);
	// è§£ææå–ç»“æœï¼ˆç®€åŒ–å¤„ç†ï¼‰
	const lines = result.split(/\n+/).filter(line => line.trim());
	let characters = [];
	let worldView = "";
	let coreConflict = "";
	let styleConstraint = "";
	
	lines.forEach(line => {
	  if (line.startsWith("1. æ ¸å¿ƒäººç‰©") || line.startsWith("æ ¸å¿ƒäººç‰©")) {
		characters = lines.slice(lines.indexOf(line)+1).filter(l => l.trim() && !l.startsWith("2.") && !l.startsWith("3.") && !l.startsWith("4.")).map(l => l.trim());
	  } else if (line.startsWith("2. ä¸–ç•Œè§‚") || line.startsWith("ä¸–ç•Œè§‚")) {
		worldView = line.replace(/^2. ä¸–ç•Œè§‚ï¼š?/, "").replace(/^ä¸–ç•Œè§‚ï¼š?/, "").trim();
	  } else if (line.startsWith("3. æ ¸å¿ƒå†²çª") || line.startsWith("æ ¸å¿ƒå†²çª")) {
		coreConflict = line.replace(/^3. æ ¸å¿ƒå†²çªï¼š?/, "").replace(/^æ ¸å¿ƒå†²çªï¼š?/, "").trim();
	  } else if (line.startsWith("4. é£æ ¼çº¦æŸ") || line.startsWith("é£æ ¼çº¦æŸ")) {
		styleConstraint = line.replace(/^4. é£æ ¼çº¦æŸï¼š?/, "").replace(/^é£æ ¼çº¦æŸï¼š?/, "").trim();
	  }
	});
	BOOK.coreSettings = { characters, worldView, coreConflict, styleConstraint };
	saveNow();
  } catch (e) {
	console.error("æå–æ ¸å¿ƒè®¾å®šå¤±è´¥ï¼š", e);
	alert("æ ¸å¿ƒè®¾å®šæå–å¤±è´¥ï¼Œä½†ä¸å½±å“ç« èŠ‚ç”Ÿæˆï¼");
  }
}

// AIä¿®æ”¹ç« èŠ‚
async function aiEdit() {
  const chapNum = document.getElementById("editChap").value;
  const tip = document.getElementById("editTip").value.trim();
  const chap = BOOK.contents.find(c => c.num == chapNum);
const totalWan = parseFloat(document.getElementById("totalWan").value) || 0.5;
const avgWordsPerChapter = 1500;
const minWordPerChap = Math.round(avgWordsPerChapter * 0.8);
const maxWordPerChap = Math.round(avgWordsPerChapter * 1.2);
const view = BOOK.view;
const style = BOOK.style;
if (!chap || !tip) return alert("è¯·é€‰æ‹©ç« èŠ‚å¹¶å¡«å†™ä¿®æ”¹å»ºè®®");

const genBtn = document.querySelector("#step6 .btn-primary");
genBtn.disabled = true;
const loading = document.getElementById("editLoading");
loading.classList.remove("hide");
startProgress("editProgressBar");

try {
  const result = await aiRequest(
	`ä½ æ˜¯ç½‘ç»œå°è¯´ä¿®æ”¹åŠ©æ‰‹ï¼Œå¿…é¡»ç™¾åˆ†ç™¾éµå¾ªåŸå¤§çº²ã€ç»†çº²ã€ç« çº²çš„æ ¸å¿ƒè®¾å®šï¼ˆä¸å¾—æ”¹å˜æ ¸å¿ƒæƒ…èŠ‚ã€äººç‰©èƒŒæ™¯ã€ä¼ç¬”çº¿ç´¢ï¼‰ï¼Œä»…æŒ‰ä¿®æ”¹å»ºè®®è°ƒæ•´è¡¨è¿°ï¼›ä¿æŒå†™ä½œè§†è§’ä¸º${view}ã€é£æ ¼ä¸º${style}ï¼›ç”¨å¸¸è§æ˜“æ‡‚çš„æ¯”å–»ã€å‡å°‘è¿‡åº¦ä¿®é¥°ã€è¯­è¨€é€šä¿—æµç•…ï¼Œæ— AIå‘³ï¼Œæ”¹å®Œä¸ç”¨äºŒæ¬¡è°ƒæ•´ï¼›ä¸¥æ ¼æŒ‰ä¿®æ”¹å»ºè®®æ”¹ï¼Œä¸åç¦»åŸæƒ…èŠ‚ï¼›ä¿®æ”¹åå­—æ•°æ§åˆ¶åœ¨${minWordPerChap}-${maxWordPerChap}å­—ï¼ˆä¸å¾—è¶…å‡ºï¼‰ã€‚`,
	`ä¿®æ”¹ä»¥ä¸‹ç« èŠ‚å†…å®¹ï¼ˆè¦æ±‚ï¼š${tip}ï¼‰ï¼Œä¿æŒ${view}/${style}é£æ ¼å’ŒåŸè®¾å®šï¼Œä¸å¾—æ”¹å˜æ ¸å¿ƒæƒ…èŠ‚ï¼š\nåŸå†…å®¹ï¼š${chap.content}`,
	false
  );
  // æ ¡éªŒä¿®æ”¹åå­—æ•°
  const chapWords = countChineseWords(result);
  if (chapWords < minWordPerChap || chapWords > maxWordPerChap) {
	throw new Error(`ä¿®æ”¹åå­—æ•°ä¸ç¬¦åˆè¦æ±‚ï¼ˆå½“å‰${chapWords}å­—ï¼Œéœ€${minWordPerChap}-${maxWordPerChap}å­—ï¼‰`);
  }
  chap.content = result;
  renderAll();
  saveNow();
  alert(`ç¬¬${chapNum}ç« ä¿®æ”¹æˆåŠŸï¼ï¼ˆ${chapWords}å­—ï¼Œç¬¦åˆå­—æ•°è¦æ±‚ï¼‰`);
} catch (e) {
  console.error("ä¿®æ”¹ç« èŠ‚å¤±è´¥ï¼š", e);
  alert("ä¿®æ”¹ç« èŠ‚å¤±è´¥ï¼š" + e.message);
} finally {
  genBtn.disabled = false;
  loading.classList.add("hide");
  resetProgress("editProgressBar");
}
}

// å¯¼å‡ºTXTï¼ˆå®Œæ•´åŠŸèƒ½ï¼‰
function exportTxt() {
  if (BOOK.contents.length === 0) return alert("æš‚æ— æ­£æ–‡å¯å¯¼å‡ºï¼");
  let text = `ã€Š${currentId ? globalData.projects[currentId].name : "æœªå‘½åå°è¯´"}ã€‹\n\n`;
  text += `ç›®æ ‡æ€»å­—æ•°ï¼š${BOOK.total}ä¸‡å­—\n`;
  text += `å·²ç”Ÿæˆç« èŠ‚æ•°ï¼š${BOOK.contents.length}ç« \n`;
  text += `å·²ç”Ÿæˆæ€»å­—æ•°ï¼š${countChineseWords(BOOK.contents.map(c => c.content).join(""))}å­—\n\n`;
  BOOK.contents.forEach(c => {
	text += `ç¬¬${c.num}ç« \n${c.content}\n\n`;
  });
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${currentId ? globalData.projects[currentId].name : "æœªå‘½åå°è¯´"}.txt`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
	document.body.removeChild(a);
	URL.revokeObjectURL(url);
  }, 100);
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
window.onload = function() {
  renderSelect();
  if (localStorage.getItem("theme") === "dark") {
	document.documentElement.setAttribute("data-theme", "dark");
	themeBtn.textContent = "ğŸŒ™ å¤œé—´";
  }
  updateChapterSuggestion();
  renderAll();
};

// è‡ªåŠ¨åŒæ­¥ç›®æ ‡å­—æ•°åˆ°æ­£æ–‡æ¨¡å—ï¼ˆå®æ—¶å“åº”ï¼‰
document.getElementById("totalWan").addEventListener("input", function() {
  updateChapterSuggestion(); 
  renderAll(); 
});
</script>
</body>
</html>