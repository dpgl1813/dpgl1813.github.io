<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾å¤©å†™ä½œ - æœ€ç»ˆå®Œç¾ç‰ˆ</title>
  <style>
	:root{--bg:#121212;--card:#1e1e1e;--text:#e5e7eb;--subtext:#9ca3af;--tip:#6b7280;--border:#374151;--primary:#3b82f6;--success:#10b981;--light:#374151;--danger:#ff4444;}
	[data-theme="light"]{--bg:#f8fafc;--card:#fff;--text:#1f2937;--subtext:#6b7280;--border:#e2e8f0;--primary:#2563eb;--light:#f1f5f9;}
	*{box-sizing:border-box;font-family:"Microsoft YaHei",sans-serif;margin:0;padding:0}
	body{background:var(--bg);color:var(--text);line-height:1.6}
	.head-bar{position:sticky;top:0;z-index:999;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;gap:8px;flex-wrap:nowrap;}
	/* æ ¸å¿ƒä¿®æ”¹ï¼šçº¯æ­£è¡Œæ¥·+æ—¥é—´/å¤œé—´åˆ†è‰²æ¸å˜ï¼Œå¤œé—´æ¸…æ™°ä¸åè‰² */
	.logo{
		font-weight:700;
		font-size:28px;
		/* å¼ºåˆ¶çº¯æ­£è¡Œæ¥·å­—ä½“ï¼Œå¤šåº“å…œåº•ä¸å›é€€ */
		font-family:"STKaiti","KaiTi","æ¥·ä½“_GB2312","AR PL UKai CN",serif;
		letter-spacing:2px;
		/* æ—¥é—´æ¨¡å¼ï¼šçº¢é»‘æ¸å˜ */
		background:linear-gradient(45deg, #d81f26, #000000);
		-webkit-background-clip:text;
		background-clip:text;
		color:transparent;
		margin-right:8px;
		white-space:nowrap;
	}
	/* å¤œé—´æ¨¡å¼å•ç‹¬é…è‰²ï¼šçº¢é‡‘æ¸å˜ï¼Œé«˜å¯¹æ¯”åº¦æ¸…æ™°å¯è§ï¼Œæ— é»„ç´«æ··åˆ */
	[data-theme="dark"] .logo{
		background:linear-gradient(45deg, #ff3333, #ffd700);
		-webkit-background-clip:text;
		background-clip:text;
		color:transparent;
	}
	.project-selector{padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);min-width:110px;height:40px;}
	.func-btn{padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;height:40px;display:flex;align-items:center;gap:3px;font-size:13px;}
	.func-btn:hover{background:var(--primary);color:#fff}
	.project-set-btn{display:none;}
	.project-set-btn.show{display:flex;}
	.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;display:none;}
	.modal-content{background:var(--card);padding:20px;border-radius:10px;max-width:360px;width:90%}
	.modal.active{display:flex}
	.main{max-width:1000px;margin:20px auto;padding:0 12px}
	.step-nav-wrap{display:flex;align-items:center;gap:8px;margin-bottom:16px;}
	.step-nav{display:flex;gap:8px;flex-wrap:wrap;}
	.step-nav .nav{padding:8px 12px;border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;font-size:14px}
	.step-nav .nav.active{background:var(--primary);color:#fff}
	.back-btn{padding:8px 12px;border-radius:6px;background:var(--light);color:var(--subtext);cursor:pointer;font-size:14px;}
	.back-btn:disabled{opacity:0.5;cursor:not-allowed;}
	.step-box{background:var(--card);border-radius:10px;padding:16px;margin-bottom:16px}
	.step-title{font-size:17px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:6px}
	.step-title span{width:24px;height:24px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px}
	.form-item{margin-bottom:12px}
	.label{font-weight:600;margin-bottom:6px;display:block;font-size:14px}
	input,textarea,select{width:100%;padding:9px 11px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);font-size:14px;outline:0}
	textarea{min-height:90px;resize:vertical}
	.btn{padding:10px 16px;border:none;border-radius:6px;font-weight:600;cursor:pointer;font-size:14px}
	.btn-primary{background:var(--primary);color:#fff}
	.btn-success{background:var(--success);color:#fff}
	.btn-light{background:var(--light);color:var(--text)}
	.btn-danger{background:var(--danger);color:#fff}
	.btn-group{display:flex;gap:8px;flex-wrap:nowrap;margin-top:10px;}
	.hide{display:none}
	.loading{color:var(--primary);font-weight:600;margin:8px 0;font-size:14px}
	.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
	.core-card{border:1px solid var(--border);border-radius:8px;padding:12px;background:var(--card);cursor:pointer}
	.core-card:hover{border-color:var(--primary)}
	.core-card.active{border-color:var(--success);background:rgba(16,185,129,0.1)}
	.core-title{font-weight:700;margin-bottom:6px;font-size:15px}
	/* ç« èŠ‚é—´30pxé—´è· */
	.chapter-item{margin-bottom:30px;padding-bottom:12px;}
	.result{background:var(--card);padding:14px;border-radius:8px;margin-top:12px;white-space:pre-wrap;line-height:1.8;}
	.chapter-suggestion{margin-top:8px;padding:8px;background:rgba(59,130,246,0.1);border-radius:4px;font-size:13px;color:var(--subtext)}
	.style-row{display:flex;gap:12px;margin-top:10px;}
	.style-col{flex:1;}
  </style>
</head>
<body>

<div class="head-bar">
  <div class="logo">å¾å¤©å†™ä½œ</div>
  <select id="projectSelector" class="project-selector" onchange="switchProject()"></select>
  <button class="func-btn project-set-btn" id="delProjectBtn" onclick="showDelModal()">âš™ï¸ åˆ é™¤é¡¹ç›®</button>
  <button class="func-btn" onclick="newProjectModal()">ğŸ“ æ–°å»º</button>
  <button class="func-btn" onclick="toggleSet()">âš™ï¸ è®¾ç½®</button>
  <button class="func-btn" id="themeBtn">â˜€ï¸ æ—¥é—´</button>
</div>

<!-- åˆ é™¤é¡¹ç›®å¼¹çª— -->
<div class="modal" id="delModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ—‘ï¸</span> åˆ é™¤é¡¹ç›®</div>
  <p style="margin-bottom:15px;">åˆ é™¤åæ‰€æœ‰å†…å®¹æ°¸ä¹…æ¶ˆå¤±ï¼Œä¸å¯æ¢å¤ï¼</p>
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideDelModal()">å–æ¶ˆ</button>
	<button class="btn btn-danger" onclick="deleteProjectForever()">ç¡®è®¤åˆ é™¤</button>
  </div>
</div></div>

<!-- æ–°å»ºå¼¹çª— -->
<div class="modal" id="newModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ“š</span> æ–°å»ºé¡¹ç›®</div>
  <div class="form-item"><input type="text" id="newName" placeholder="è¾“å…¥é¡¹ç›®å"></div>
  <div class="btn-group">
	<button class="btn btn-light" onclick="hideNewModal()">å–æ¶ˆ</button>
	<button class="btn btn-primary" onclick="createCleanProject()">åˆ›å»º</button>
  </div>
</div></div>

<!-- è®¾ç½®å¼¹çª— -->
<div class="modal" id="setModal"><div class="modal-content">
  <div class="step-title"><span>ğŸ”‘</span> APIè®¾ç½®</div>
  <div class="form-item"><input type="text" id="apiKey" placeholder="API Keyï¼ˆsk-xxxxï¼‰"></div>
  <div class="form-item"><input type="text" id="model" value="deepseek-chat" placeholder="æ¨¡å‹"></div>
  <div class="form-item"><input type="number" id="temp" value="0.7" step="0.1" min="0.1" max="1.0" placeholder="æ¸©åº¦(0.1-1.0)"></div>
  <div class="form-item"><input type="number" id="maxTokens" value="2048" placeholder="æœ€å¤§Tokens"></div>
  <div class="btn-group"><button class="btn btn-primary" onclick="saveApi()">ä¿å­˜è®¾ç½®</button></div>
</div></div>

<div class="main">
  <div class="step-nav-wrap">
	<button class="back-btn" id="backBtn" disabled onclick="goPrevStep()">â† è¿”å›</button>
	<div class="step-nav">
	  <div class="nav" data-step="1" onclick="goStep(1)">1 æ•…äº‹æ ¸</div>
	  <div class="nav" data-step="2" onclick="goStep(2)">2 å¤§çº²</div>
	  <div class="nav" data-step="3" onclick="goStep(3)">3 ç»†çº²</div>
	  <div class="nav" data-step="4" onclick="goStep(4)">4 ç« çº²</div>
	  <div class="nav" data-step="5" onclick="goStep(5)">5 æ­£æ–‡</div>
	  <div class="nav" data-step="6" onclick="goStep(6)">6 AIä¿®æ”¹(é€‰å¡«)</div>
	</div>
  </div>

  <!-- 1æ•…äº‹æ ¸ â†’ è§†è§’+é£æ ¼é€‰æ‹© -->
  <div id="step1" class="step-page">
	<div class="step-box"><div class="step-title"><span>1</span>çµæ„Ÿ/å…³é”®è¯ + åˆ›ä½œè®¾å®š</div>
	  <div class="form-item"><textarea id="idea" placeholder="è¾“å…¥çµæ„Ÿã€å…³é”®è¯æˆ–åˆæ­¥è®¾å®š" oninput="saveNow()"></textarea></div>
	  <div class="style-row">
		<div class="style-col">
		  <label class="label">å™äº‹è§†è§’</label>
		  <select id="viewSelect" onchange="saveNow()">
			<option value="ç¬¬ä¸‰äººç§°">ç¬¬ä¸‰äººç§°ï¼ˆé»˜è®¤ï¼‰</option>
			<option value="ç¬¬ä¸€äººç§°">ç¬¬ä¸€äººç§°</option>
		  </select>
		</div>
		<div class="style-col">
		  <label class="label">å†™ä½œé£æ ¼</label>
		  <select id="styleSelect" onchange="saveNow()">
			<option value="å°ç™½ç›´ç™½çˆ½æ–‡">å°ç™½ç›´ç™½çˆ½æ–‡ï¼ˆé»˜è®¤ï¼‰</option>
			<option value="éƒ½å¸‚å†™å®">éƒ½å¸‚å†™å®</option>
			<option value="å¤é£ç»†è…»">å¤é£ç»†è…»</option>
			<option value="æ‚¬ç–‘ç´§å‡‘">æ‚¬ç–‘ç´§å‡‘</option>
			<option value="æ ¡å›­æ¸…æ–°">æ ¡å›­æ¸…æ–°</option>
		  </select>
		</div>
	  </div>
	  <button class="btn btn-primary" onclick="genCore()" style="margin-top:12px;">ç”Ÿæˆæ•…äº‹æ ¸</button>
	  <div id="coreLoading" class="loading hide">æ­£åœ¨ç”Ÿæˆæ•…äº‹æ ¸...</div>
	  <div id="coreGrid" class="card-grid hide"></div>
	  <button class="btn btn-success hide" id="next1" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button>
	</div>
  </div>

  <!-- 2å¤§çº² â†’ ç›®æ ‡æ€»å­—æ•° -->
  <div id="step2" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>2</span>é€†æ¨å¤§çº²</div>
	  <div class="form-item">
		<label class="label">ç›®æ ‡æ€»å­—æ•°ï¼ˆä¸‡å­—ï¼‰</label>
		<input type="number" id="totalWan" value="0.5" min="0.1" step="0.1" oninput="updateChapterSuggestion()">
		<div id="chapterSuggestion" class="chapter-suggestion hide"></div>
	  </div>
	  <button class="btn btn-primary" onclick="genOutline()">ç”Ÿæˆå¤§çº²</button>
	  <div id="outlineLoading" class="loading hide">æ­£åœ¨ç”Ÿæˆå¤§çº²...</div>
	  <div class="form-item">
		<label class="label">å¤§çº²å†…å®¹</label>
		<textarea id="outline" rows="8" oninput="saveNow()"></textarea>
	  </div>
	  <button class="btn btn-success" onclick="goStep(3)">ä¸‹ä¸€æ­¥</button>
	</div>
  </div>

  <!-- 3ç»†çº² â†’ èŠ‚ç‚¹æ§åˆ¶ -->
  <div id="step3" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>3</span>ç»†çº²</div>
	  <button class="btn btn-primary" onclick="genDetail()">ç”Ÿæˆç»†çº²</button>
	  <div id="detailLoading" class="loading hide">æ­£åœ¨ç”Ÿæˆç»†çº²...</div>
	  <div class="form-item">
		<label class="label">ç»†çº²å†…å®¹</label>
		<textarea id="detail" rows="10" oninput="saveNow()"></textarea>
	  </div>
	  <button class="btn btn-success" onclick="goStep(4)">ä¸‹ä¸€æ­¥</button>
	</div>
  </div>

  <!-- 4ç« çº² â†’ å­—æ•°é€‚é… -->
  <div id="step4" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>4</span>ç« çº²</div>
	  <button class="btn btn-primary" onclick="genZhang()">ç”Ÿæˆç« çº²</button>
	  <div id="zhangLoading" class="loading hide">æ­£åœ¨ç”Ÿæˆç« çº²...</div>
	  <div class="form-item">
		<label class="label">ç« çº²å†…å®¹</label>
		<textarea id="zhang" rows="12" oninput="saveNow()"></textarea>
	  </div>
	  <button class="btn btn-success" onclick="goStep(5)">ä¸‹ä¸€æ­¥</button>
	</div>
  </div>

  <!-- 5æ­£æ–‡ â†’ ä¸¥æ ¼éµå¾ªç« çº² + ä¿®å¤ä¸€é”®å¤åˆ¶ -->
  <div id="step5" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>5</span>æ­£æ–‡ç”Ÿæˆ</div>
	  <div class="form-item">
		<label class="label">ç« èŠ‚å·</label>
		<input type="number" id="chapNum" value="1" min="1" step="1">
	  </div>
	  <button class="btn btn-primary" onclick="writeChap()">ç”Ÿæˆç« èŠ‚</button>
	  <div id="chapLoading" class="loading hide">æ­£åœ¨ç”Ÿæˆæ­£æ–‡...</div>
	  <div class="btn-group">
		<button class="btn btn-light" onclick="copyAllText()">âœ… ä¸€é”®å¤åˆ¶å…¨æ–‡</button>
		<button class="btn btn-light" onclick="exportTxt()" style="display:none;">ğŸ“„ å¯¼å‡ºTXT</button>
	  </div>
	  <div class="form-item">
		<label class="label">æ­£æ–‡å†…å®¹</label>
		<div id="resultWrite" class="result"></div>
	  </div>
	  <button class="btn btn-light" onclick="goStep(6)" style="margin-top:10px;">â†’ è¿›å…¥AIä¿®æ”¹</button>
	</div>
  </div>

  <!-- 6AIä¿®æ”¹ â†’ ä¿æŒé£æ ¼ä¸€è‡´ -->
  <div id="step6" class="step-page hide">
	<div class="step-box"><div class="step-title"><span>6</span>AIä¿®æ”¹(é€‰å¡«)</div>
	  <div class="form-item">
		<label class="label">é€‰æ‹©ç« èŠ‚</label>
		<select id="editChap"></select>
	  </div>
	  <div class="form-item">
		<label class="label">ä¿®æ”¹å»ºè®®</label>
		<textarea id="editTip" placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®ï¼šå¦‚å¢åŠ æƒ…ç»ªã€è°ƒæ•´èŠ‚å¥ã€å±€éƒ¨æ”¹å†™"></textarea>
	  </div>
	  <button class="btn btn-primary" onclick="aiEdit()">æäº¤ä¿®æ”¹</button>
	  <div id="editLoading" class="loading hide">æ­£åœ¨ä¿®æ”¹ç« èŠ‚...</div>
	  <button class="btn btn-light" onclick="goStep(5)" style="margin-top:10px;">â† è¿”å›æ­£æ–‡</button>
	</div>
  </div>
</div>

<script>
// å…¨å±€é»˜è®¤é…ç½®
const DEFAULT_BOOK = {
  idea: "",
  core: "",
  view: "ç¬¬ä¸‰äººç§°",
  style: "å°ç™½ç›´ç™½çˆ½æ–‡",
  total: 0.5,
  outline: "",
  detail: "",
  zhang: "",
  contents: []
};
let globalData = JSON.parse(localStorage.getItem("writeData") || JSON.stringify({
  projects: {},
  api: "",
  model: "deepseek-chat",
  temp: 0.7,
  maxTokens: 2048
}));
let currentId = null;
let currentStep = 1;
let BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));

// ä¸»é¢˜åˆ‡æ¢
const themeBtn = document.getElementById("themeBtn");
themeBtn.onclick = () => {
  let dark = localStorage.getItem("theme") === "dark";
  dark = !dark;
  localStorage.setItem("theme", dark ? "dark" : "light");
  document.documentElement.setAttribute("data-theme", dark ? "dark" : "light");
  themeBtn.textContent = dark ? "ğŸŒ™ å¤œé—´" : "â˜€ï¸ æ—¥é—´";
}

// æ¸²æŸ“é¡¹ç›®ä¸‹æ‹‰
function renderSelect() {
  let sel = document.getElementById("projectSelector");
  sel.innerHTML = '<option value="">é€‰æ‹©é¡¹ç›®</option>';
  for (let id in globalData.projects) {
	let opt = document.createElement("option");
	opt.value = id;
	opt.textContent = globalData.projects[id].name;
	sel.appendChild(opt);
  }
  document.getElementById("delProjectBtn").classList.toggle("show", !!currentId);
}

// åˆ‡æ¢é¡¹ç›®
function switchProject() {
  currentId = document.getElementById("projectSelector").value;
  if (!currentId) {
	BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
	renderAll();
	goStep(1);
	return;
  }
  BOOK = JSON.parse(JSON.stringify(globalData.projects[currentId].data));
  renderAll();
  goStep(globalData.projects[currentId].step || 1);
}

// æ–°å»ºå¼¹çª—
function newProjectModal() {
  document.getElementById("newName").value = "";
  document.getElementById("newModal").classList.add("active");
}
function hideNewModal() {
  document.getElementById("newName").value = "";
  document.getElementById("newModal").classList.remove("active");
}

// åˆ›å»ºé¡¹ç›®
function createCleanProject() {
  let name = document.getElementById("newName").value.trim();
  if (!name) return alert("è¯·è¾“å…¥é¡¹ç›®å");
  let id = "p" + Date.now();
  globalData.projects[id] = {
	name: name,
	step: 1,
	data: JSON.parse(JSON.stringify(DEFAULT_BOOK))
  };
  saveGlobal();
  hideNewModal();
  currentId = id;
  BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
  renderSelect();
  renderAll();
  goStep(1);
}

// åˆ é™¤é¡¹ç›®
function showDelModal() { document.getElementById("delModal").classList.add("active") }
function hideDelModal() { document.getElementById("delModal").classList.remove("active") }
function deleteProjectForever() {
  if (!currentId) return;
  delete globalData.projects[currentId];
  saveGlobal();
  currentId = null;
  BOOK = JSON.parse(JSON.stringify(DEFAULT_BOOK));
  renderSelect();
  renderAll();
  goStep(1);
  hideDelModal();
  alert("é¡¹ç›®å·²å½»åº•åˆ é™¤ï¼");
}

// è®¾ç½®å¼¹çª—
function toggleSet() {
  document.getElementById("apiKey").value = globalData.api || "";
  document.getElementById("model").value = globalData.model || "deepseek-chat";
  document.getElementById("temp").value = globalData.temp || 0.7;
  document.getElementById("maxTokens").value = globalData.maxTokens || 2048;
  document.getElementById("setModal").classList.toggle("active");
}
function saveApi() {
  globalData.api = document.getElementById("apiKey").value.trim();
  globalData.model = document.getElementById("model").value.trim();
  globalData.temp = parseFloat(document.getElementById("temp").value) || 0.7;
  globalData.maxTokens = parseInt(document.getElementById("maxTokens").value) || 2048;
  saveGlobal();
  alert("APIè®¾ç½®ä¿å­˜æˆåŠŸï¼");
  document.getElementById("setModal").classList.remove("active");
}

// æ­¥éª¤åˆ‡æ¢
function goStep(s) {
  const stepCheck = {
	2: () => !!BOOK.core,
	3: () => !!BOOK.outline.trim(),
	4: () => !!BOOK.detail.trim(),
	5: () => !!BOOK.zhang.trim(),
	6: () => BOOK.contents.length > 0
  };
  if (stepCheck[s] && !stepCheck[s]()) {
	const tips = {
	  2: "è¯·å…ˆç”Ÿæˆå¹¶é€‰æ‹©æ•…äº‹æ ¸",
	  3: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™å¤§çº²",
	  4: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™ç»†çº²",
	  5: "è¯·å…ˆç”Ÿæˆæˆ–å¡«å†™ç« çº²",
	  6: "è¯·å…ˆç”Ÿæˆè‡³å°‘ä¸€ç« æ­£æ–‡"
	};
	alert(tips[s]);
	return;
  }

  document.querySelectorAll(".step-page").forEach(p => p.classList.add("hide"));
  document.querySelectorAll(".nav").forEach(n => n.classList.remove("active"));
  document.getElementById(`step${s}`).classList.remove("hide");
  document.querySelector(`.nav[data-step="${s}"]`).classList.add("active");
  currentStep = s;
  document.getElementById("backBtn").disabled = s === 1;
  if (currentId) globalData.projects[currentId].step = s;
  saveGlobal();
}

// è¿”å›ä¸Šä¸€æ­¥
function goPrevStep() {
  if (currentStep <= 1) return;
  goStep(currentStep - 1);
}

// æ•°æ®ä¿å­˜
function saveGlobal() { localStorage.setItem("writeData", JSON.stringify(globalData)) }
function saveNow() {
  if (!currentId) return;
  BOOK.idea = document.getElementById("idea").value;
  BOOK.view = document.getElementById("viewSelect").value;
  BOOK.style = document.getElementById("styleSelect").value;
  BOOK.total = parseFloat(document.getElementById("totalWan").value) || 0.5;
  BOOK.outline = document.getElementById("outline").value;
  BOOK.detail = document.getElementById("detail").value;
  BOOK.zhang = document.getElementById("zhang").value;
  globalData.projects[currentId].data = JSON.parse(JSON.stringify(BOOK));
  saveGlobal();
}

// æ¸²æŸ“æ‰€æœ‰å†…å®¹
function renderAll() {
  document.getElementById("idea").value = BOOK.idea || "";
  document.getElementById("viewSelect").value = BOOK.view || "ç¬¬ä¸‰äººç§°";
  document.getElementById("styleSelect").value = BOOK.style || "å°ç™½ç›´ç™½çˆ½æ–‡";
  document.getElementById("totalWan").value = BOOK.total || 0.5;
  document.getElementById("outline").value = BOOK.outline || "";
  document.getElementById("detail").value = BOOK.detail || "";
  document.getElementById("zhang").value = BOOK.zhang || "";
  
  updateChapterSuggestion();
  
  let res = document.getElementById("resultWrite");
  res.innerHTML = "";
  BOOK.contents.forEach(c => {
	let div = document.createElement("div");
	div.className = "chapter-item";
	div.innerHTML = `<h3>ç¬¬${c.num}ç« </h3><p>${c.content}</p>`;
	res.appendChild(div);
  });
  
  let sel = document.getElementById("editChap");
  sel.innerHTML = '<option value="">é€‰ç« èŠ‚</option>';
  BOOK.contents.forEach(c => {
	let opt = document.createElement("option");
	opt.value = c.num;
	opt.textContent = `ç¬¬${c.num}ç« `;
	sel.appendChild(opt);
  });
}

// ç›®æ ‡å­—æ•°-ç« çº²é€‚é…
function updateChapterSuggestion() {
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0;
  if (totalWan <= 0) {
	document.getElementById("chapterSuggestion").classList.add("hide");
	return;
  }
  const totalWords = totalWan * 10000;
  const avgWordsPerChapter = 1500;
  const suggestedChapters = Math.round(totalWords / avgWordsPerChapter);
  const minChapters = Math.max(3, Math.floor(suggestedChapters * 0.8));
  const maxChapters = Math.ceil(suggestedChapters * 1.2);
  const suggestionText = `ğŸ’¡ å»ºè®®ç« çº²æ•°ï¼š${minChapters}-${maxChapters} ç« ï¼ˆæ¯ç« çº¦${avgWordsPerChapter}å­—ï¼Œç›®æ ‡æ€»å­—æ•°çº¦${totalWords}å­—ï¼‰`;
  document.getElementById("chapterSuggestion").textContent = suggestionText;
  document.getElementById("chapterSuggestion").classList.remove("hide");
}

// ä¸€é”®å¤åˆ¶ä¿®å¤ï¼ˆåŒæ–¹æ¡ˆå…¼å®¹ï¼‰
function copyAllText() {
  let text = "";
  BOOK.contents.forEach(c => {
	text += `ç¬¬${c.num}ç« \n${c.content}\n\n`;
  });
  if (!text.trim()) return alert("æš‚æ— æ­£æ–‡å¯å¤åˆ¶ï¼");
  
  if (navigator.clipboard && window.isSecureContext) {
	navigator.clipboard.writeText(text).then(() => {
	  alert("âœ… å…¨æ–‡å¤åˆ¶æˆåŠŸï¼");
	}).catch(err => {
	  console.error("å¤åˆ¶å¤±è´¥ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰ï¼š", err);
	  fallbackCopy(text);
	});
  } else {
	fallbackCopy(text);
  }
}

// å¤åˆ¶é™çº§æ–¹æ¡ˆ
function fallbackCopy(text) {
  const textarea = document.createElement("textarea");
  textarea.value = text;
  textarea.style.position = "fixed";
  textarea.style.opacity = "0";
  document.body.appendChild(textarea);
  textarea.select();
  try {
	document.execCommand("copy");
	alert("âœ… å…¨æ–‡å¤åˆ¶æˆåŠŸï¼");
  } catch (err) {
	console.error("å¤åˆ¶å¤±è´¥ï¼ˆé™çº§æ–¹æ¡ˆï¼‰ï¼š", err);
	alert("âš ï¸ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æ­£æ–‡å†…å®¹ï¼");
  } finally {
	document.body.removeChild(textarea);
  }
}

// å¯¼å‡ºTXTï¼ˆéšè—ï¼‰
function exportTxt() {
  let text = "";
  BOOK.contents.forEach(c => {
	text += `ç¬¬${c.num}ç« \n${c.content}\n\n`;
  });
  if (!text.trim()) return alert("æš‚æ— æ­£æ–‡å¯å¯¼å‡ºï¼");
  let blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url;
  a.download = "å¾å¤©å†™ä½œ_" + (currentId ? globalData.projects[currentId].name : "æ­£æ–‡") + ".txt";
  a.click();
  URL.revokeObjectURL(url);
}

// AIè¯·æ±‚åŸºç¡€å‡½æ•°
async function aiRequest(system, user) {
  if (!globalData.api) {
	alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­å¡«å†™æœ‰æ•ˆçš„API Keyï¼");
	throw new Error("æœªé…ç½®API Key");
  }
  try {
	let res = await fetch("https://api.deepseek.com/v1/chat/completions", {
	  method: "POST",
	  headers: { "Authorization": "Bearer " + globalData.api, "Content-Type": "application/json" },
	  body: JSON.stringify({
		model: globalData.model,
		messages: [{ role: "system", content: system }, { role: "user", content: user }],
		temperature: globalData.temp,
		max_tokens: globalData.maxTokens,
		stream: false
	  })
	});
	if (!res.ok) {
	  let errorData = await res.json().catch(() => ({}));
	  throw new Error(`APIè¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${res.status}ï¼‰ï¼š${errorData.message || "ç½‘ç»œå¼‚å¸¸"}`);
	}
	let data = await res.json();
	if (data.error) throw new Error(data.error.message);
	return data.choices[0].message.content;
  } catch (e) {
	alert("AIè¯·æ±‚å¤±è´¥ï¼š" + e.message);
	throw e;
  }
}

// ç”Ÿæˆæ•…äº‹æ ¸
async function genCore() {
  const idea = document.getElementById("idea").value.trim();
  if (!idea) return alert("è¯·è¾“å…¥çµæ„Ÿ/å…³é”®è¯");
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step1 .btn-primary");
  const loading = document.getElementById("coreLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´æ•…äº‹æ ¸å†™æ‰‹ï¼Œä¸¥æ ¼ç”Ÿæˆ5ä¸ªä¸åŒçš„é€‰é¡¹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›ç”¨æ—¥å¸¸å¸¸è§çš„æ¯”å–»ï¼Œæ‹’ç»ç”Ÿåƒ»/å¥‡æ€ªæ¯”å–»ï¼Œå‡å°‘è¿‡åº¦åä¸½ä¿®é¥°ï¼Œèšç„¦æ ¸å¿ƒå†²çªï¼Œè¯­è¨€è´´è¿‘çœŸäººæ‰‹å†™é£æ ¼ï¼Œæ— AIåˆ»æ¿æ„Ÿã€‚`,
	  `æ ¹æ®çµæ„Ÿå…³é”®è¯ç”Ÿæˆ5ä¸ª${style}é£æ ¼çš„${view}æ•…äº‹æ ¸é€‰é¡¹ï¼Œæ¯ä¸ªä¸è¶…è¿‡100å­—ï¼Œç”¨æ•°å­—ç¼–å·ï¼ˆ1. 2. 3. 4. 5.ï¼‰ï¼š${idea}`
	);
	const coreList = result.split(/\n+/)
	  .filter(item => item.trim() && /^\d+\./.test(item))
	  .map(item => item.replace(/^\d+\./, "").trim());
	while (coreList.length < 5) {
	  coreList.push(`${idea}ï¼ˆ${view}/${style}é£æ ¼ï¼Œå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰`);
	}
	document.getElementById("coreGrid").innerHTML = coreList.map((item, idx) => `
	  <div class="core-card" onclick="selectCore('${idx}')">
		<div class="core-title">æ•…äº‹æ ¸${idx+1}</div>
		<div>${item}</div>
	  </div>
	`).join("");
	document.getElementById("coreGrid").classList.remove("hide");
  } catch (e) {
	console.error("ç”Ÿæˆæ•…äº‹æ ¸å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// é€‰æ‹©æ•…äº‹æ ¸
function selectCore(idx) {
  const coreCards = document.querySelectorAll(".core-card");
  coreCards.forEach((card, i) => {
	card.classList.toggle("active", i == idx);
  });
  BOOK.core = coreCards[idx].querySelector("div:last-child").textContent;
  saveNow();
  document.getElementById("next1").classList.remove("hide");
}

// ç”Ÿæˆå¤§çº²ï¼ˆæŒ‰ç›®æ ‡å­—æ•°ï¼‰
async function genOutline() {
  if (!BOOK.core) return alert("è¯·å…ˆé€‰æ‹©æ•…äº‹æ ¸");
  const totalWan = document.getElementById("totalWan").value;
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step2 .btn-primary");
  const loading = document.getElementById("outlineLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´å¤§çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›ç”¨é€šä¿—ç›´ç™½çš„è¯­è¨€ï¼Œåˆ†3-5ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µèšç„¦æ ¸å¿ƒæƒ…èŠ‚æ¨è¿›ï¼Œä¸ç”¨ç”Ÿåƒ»æ¯”å–»å’Œè¿‡åº¦ä¿®é¥°ï¼Œç¬¦åˆç½‘ç»œå°è¯´èŠ‚å¥ï¼Œæ— AIå‘³ã€‚`,
	  `æ ¹æ®æ•…äº‹æ ¸ç”Ÿæˆ${totalWan}ä¸‡å­—çš„${style}é£æ ¼${view}å°è¯´å¤§çº²ï¼Œæ¯ä¸ªé˜¶æ®µè¯´æ˜æ ¸å¿ƒå†²çªå’Œæƒ…èŠ‚èµ°å‘ï¼š${BOOK.core}`
	);
	document.getElementById("outline").value = result;
	BOOK.outline = result;
	saveNow();
	alert("å¤§çº²ç”ŸæˆæˆåŠŸï¼");
  } catch (e) {
	console.error("ç”Ÿæˆå¤§çº²å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// ç”Ÿæˆç»†çº²
async function genDetail() {
  if (!BOOK.outline.trim()) return alert("è¯·å…ˆå¡«å†™å¤§çº²");
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step3 .btn-primary");
  const loading = document.getElementById("detailLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ç»†çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›æ‹†è§£ä¸ºå…³é”®èŠ‚ç‚¹ï¼Œæ¯ä¸ªé˜¶æ®µèŠ‚ç‚¹ä¸è¶…è¿‡3ä¸ªï¼ŒèŠ‚ç‚¹æ˜¯æ ¸å¿ƒè½¬æŠ˜ç‚¹/ä¿¡æ¯æ­éœ²/è§’è‰²æŠ‰æ‹©ï¼Œæ¯èŠ‚ç‚¹ä¸è¶…50å­—ï¼Œé€»è¾‘é€’è¿›ï¼Œæ— AIå‘³ã€‚`,
	  `å°†ä»¥ä¸‹å¤§çº²æ‹†è§£ä¸º${style}é£æ ¼${view}ç»†çº²ï¼Œä¸¥æ ¼éµå®ˆè¦æ±‚ï¼š\n\n${BOOK.outline}`
	);
	document.getElementById("detail").value = result;
	BOOK.detail = result;
	saveNow();
	alert("ç»†çº²ç”ŸæˆæˆåŠŸï¼");
  } catch (e) {
	console.error("ç”Ÿæˆç»†çº²å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// ç”Ÿæˆç« çº²ï¼ˆæŒ‰ç›®æ ‡å­—æ•°é€‚é…ï¼‰
async function genZhang() {
  if (!BOOK.detail.trim()) return alert("è¯·å…ˆå¡«å†™ç»†çº²");
  const totalWan = parseFloat(document.getElementById("totalWan").value) || 0.5;
  const totalWords = totalWan * 10000;
  const avgWordsPerChapter = 1500;
  const suggestedChapters = Math.round(totalWords / avgWordsPerChapter);
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step4 .btn-primary");
  const loading = document.getElementById("zhangLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ç« çº²å†™æ‰‹ï¼Œå†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›æ€»å­—æ•°çº¦${totalWords}å­—ï¼Œå»ºè®®ç”Ÿæˆ${suggestedChapters}ç« ï¼Œæ¯ç« çº¦${avgWordsPerChapter}å­—ï¼›ä¸¥æ ¼åŸºäºç»†çº²ï¼Œæ¯ç« ä»¥"**ç¬¬Xç«  æ ‡é¢˜**"å¼€å¤´ï¼Œæ ¸å¿ƒå†…å®¹ä¸è¶…80å­—ï¼Œæ¸…æ™°æ˜äº†ã€‚`,
	  `æ ¹æ®ä»¥ä¸‹ç»†çº²ç”Ÿæˆ${style}é£æ ¼${view}ç« çº²ï¼Œä¸¥æ ¼éµå®ˆè¦æ±‚ï¼š\n\n${BOOK.detail}`
	);
	document.getElementById("zhang").value = result;
	BOOK.zhang = result;
	saveNow();
	alert("ç« çº²ç”ŸæˆæˆåŠŸï¼");
  } catch (e) {
	console.error("ç”Ÿæˆç« çº²å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// ç”Ÿæˆæ­£æ–‡
async function writeChap() {
  if (!BOOK.zhang.trim()) return alert("è¯·å…ˆå¡«å†™ç« çº²");
  const chapNum = document.getElementById("chapNum").value;
  const view = BOOK.view;
  const style = BOOK.style;
  
  const genBtn = document.querySelector("#step5 .btn-primary");
  const loading = document.getElementById("chapLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´æ­£æ–‡å†™æ‰‹ï¼Œ**ä¸¥æ ¼éµå¾ªç« çº²åˆ›ä½œï¼Œä¸å¾—æ–°å¢æœªæåŠçš„æƒ…èŠ‚/è®¾å®š/äººç‰©**ï¼›å†™ä½œè§†è§’ä¸º${view}ï¼Œé£æ ¼ä¸º${style}ï¼›ç”¨æ—¥å¸¸å¸¸è§çš„æ¯”å–»ï¼Œå‡å°‘è¿‡åº¦åä¸½ä¿®é¥°ï¼Œèšç„¦æƒ…èŠ‚æ¨è¿›å’Œè§’è‰²åŠ¨ä½œï¼Œå¯¹è¯ç¬¦åˆé£æ ¼/è§†è§’ï¼Œè¯»èµ·æ¥åƒçœŸäººæ‰‹å†™ï¼Œä¸ç”¨æ”¹å¯ç›´æ¥å‘å¸ƒï¼Œæ¯ç« çº¦1500å­—ã€‚`,
	  `æ ¹æ®ä»¥ä¸‹ç« çº²ç”Ÿæˆç¬¬${chapNum}ç« ${style}é£æ ¼${view}æ­£æ–‡ï¼Œä¸¥æ ¼éµå®ˆè¦æ±‚ï¼š\n\n${BOOK.zhang}`
	);
	const existing = BOOK.contents.find(c => c.num == chapNum);
	if (existing) {
	  existing.content = result;
	} else {
	  BOOK.contents.push({ num: chapNum, content: result });
	}
	renderAll();
	saveNow();
	alert(`ç¬¬${chapNum}ç« ç”ŸæˆæˆåŠŸï¼`);
  } catch (e) {
	console.error("ç”Ÿæˆæ­£æ–‡å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// AIä¿®æ”¹
async function aiEdit() {
  const chapNum = document.getElementById("editChap").value;
  const tip = document.getElementById("editTip").value.trim();
  const chap = BOOK.contents.find(c => c.num == chapNum);
  const view = BOOK.view;
  const style = BOOK.style;
  if (!chap || !tip) return alert("è¯·é€‰æ‹©ç« èŠ‚å¹¶å¡«å†™ä¿®æ”¹å»ºè®®");
  
  const genBtn = document.querySelector("#step6 .btn-primary");
  const loading = document.getElementById("editLoading");
  genBtn.disabled = true;
  loading.classList.remove("hide");

  try {
	const result = await aiRequest(
	  `ä½ æ˜¯ç½‘ç»œå°è¯´ä¿®æ”¹åŠ©æ‰‹ï¼Œä¿æŒå†™ä½œè§†è§’ä¸º${view}ã€é£æ ¼ä¸º${style}ï¼›ç”¨å¸¸è§æ˜“æ‡‚çš„æ¯”å–»ã€å‡å°‘è¿‡åº¦ä¿®é¥°ã€è¯­è¨€é€šä¿—æµç•…ï¼Œæ— AIå‘³ï¼Œæ”¹å®Œä¸ç”¨äºŒæ¬¡è°ƒæ•´ï¼›ä¸¥æ ¼æŒ‰ä¿®æ”¹å»ºè®®æ”¹ï¼Œä¸åç¦»åŸæƒ…èŠ‚ã€‚`,
	  `ä¿®æ”¹ä»¥ä¸‹ç« èŠ‚å†…å®¹ï¼ˆè¦æ±‚ï¼š${tip}ï¼‰ï¼Œä¿æŒ${view}/${style}é£æ ¼ï¼š\nåŸå†…å®¹ï¼š${chap.content}`
	);
	chap.content = result;
	renderAll();
	saveNow();
	alert(`ç¬¬${chapNum}ç« ä¿®æ”¹æˆåŠŸï¼`);
  } catch (e) {
	console.error("ä¿®æ”¹ç« èŠ‚å¤±è´¥ï¼š", e);
  } finally {
	genBtn.disabled = false;
	loading.classList.add("hide");
  }
}

// åˆå§‹åŒ–
renderSelect();
if (localStorage.getItem("theme") === "dark") {
  document.documentElement.setAttribute("data-theme", "dark");
  themeBtn.textContent = "ğŸŒ™ å¤œé—´";
}
</script>
</body>
</html>